(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const a of s)if(a.type==="childList")for(const o of a.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const a={};return s.integrity&&(a.integrity=s.integrity),s.referrerPolicy&&(a.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?a.credentials="include":s.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function i(s){if(s.ep)return;s.ep=!0;const a=t(s);fetch(s.href,a)}})();class Z{constructor(e=100){this.MAX_ELEMENTS=e,this.q=new Array(this.MAX_ELEMENTS),this.head=0,this.tail=0,this.size=0}enqueue(e){if((this.tail+1)%this.MAX_ELEMENTS===this.head)throw new Error("Queue full - cannot add element");this.size+=1,this.q[this.tail]=e,this.tail=(this.tail+1)%this.MAX_ELEMENTS}dequeue(){if(this.head===this.tail)throw new Error("Queue empty - cannot remove element");this.size-=1;let e=this.q[this.head];return delete this.q[this.head],this.head=(this.head+1)%this.MAX_ELEMENTS,e}peekNext(){if(this.head===this.tail)throw"Queue empty - cannot get element";return this.q[this.head]}hasItems(){return this.head!==this.tail}getSize(){return this.size}clear(){this.forEach((e,t)=>delete this.q[t]),this.size=0,this.head=this.tail}forEach(e){let t=this.head;for(;t!==this.tail;)e(this.q[t],t),t=(t+1)%this.MAX_ELEMENTS}toString(){let e="";return this.forEach((t,i)=>{let s=t.toString();i!==0&&(s+=" -> "),e=s+e}),"Top -> "+e}}class L{constructor(){this.map={}}add(e,t){this.map[e]=t}get(e){return this.map[e]}set(e,t){this.add(e,t)}has(e){return this.map[e]!==void 0}keys(){return Object.keys(this.map)}forEach(e){Object.keys(this.map).forEach(t=>e(t))}delete(e){delete this.map[e]}clear(){this.forEach(e=>delete this.map[e])}toString(){let e="";return this.forEach(t=>e+=t+" -> "+this.get(t).toString()+`
`),e}}var p;(function(n){n.MOUSE_DOWN="mouse_down",n.MOUSE_UP="mouse_up",n.MOUSE_MOVE="mouse_move",n.KEY_DOWN="key_down",n.KEY_UP="key_up",n.CANVAS_BLUR="canvas_blur",n.WHEEL_UP="wheel_up",n.WHEEL_DOWN="wheel_down",n.START_RECORDING="start_recording",n.STOP_RECORDING="stop_recording",n.PLAY_RECORDING="play_recording",n.PLAY_SOUND="play_sound",n.STOP_SOUND="stop_sound",n.PLAY_SFX="play_sfx",n.PLAY_MUSIC="play_music",n.MUTE_CHANNEL="mute_channel",n.UNMUTE_CHANNEL="unmute_channel",n.ALL="all"})(p||(p={}));class te{constructor(){this.MAX_SIZE=100,this.q=new Z(this.MAX_SIZE),this.receivers=new L}static getInstance(){return this.instance===null&&(this.instance=new te),this.instance}addEvent(e){this.q.enqueue(e)}subscribe(e,t){if(t instanceof Array)for(let i of t)this.addListener(e,i);else this.addListener(e,t)}unsubscribe(e,...t){this.receivers.forEach(i=>{if(t.length>0&&t.indexOf(i)===-1)return;let s=this.receivers.get(i).indexOf(e);s!==-1&&this.receivers.get(i).splice(s,1)})}addListener(e,t){this.receivers.has(t)?this.receivers.get(t).push(e):this.receivers.add(t,[e])}update(e){for(;this.q.hasItems();){let t=this.q.dequeue();if(this.receivers.has(t.type))for(let i of this.receivers.get(t.type))i.receive(t);if(this.receivers.has(p.ALL))for(let i of this.receivers.get(p.ALL))i.receive(t)}}}te.instance=null;class ye{constructor(){this.MAX_SIZE=100,this.q=new Z(this.MAX_SIZE)}destroy(){te.getInstance().unsubscribe(this)}subscribe(e){te.getInstance().subscribe(this,e),this.q.clear()}receive(e){try{this.q.enqueue(e)}catch(t){throw console.warn("Receiver overflow for event "+e.toString()),t}}getNextEvent(){return this.q.dequeue()}peekNextEvent(){return this.q.peekNext()}hasNextEvent(){return this.q.hasItems()}ignoreEvents(){this.q.clear()}}class w{static sign(e){return e<0?-1:1}static between(e,t,i,s){return s?e<i&&i<t:e<=i&&i<=t}static clamp(e,t,i){return e<t?t:e>i?i:e}static clamp01(e){return w.clamp(e,0,1)}static clampLow(e,t){return e<t?t:e}static clampLow0(e){return w.clampLow(e,0)}static clampMagnitude(e,t){return e.magSq()>t*t?e.scaleTo(t):e}static changeRange(e,t,i,s,a){return this.lerp(s,a,this.invLerp(t,i,e))}static lerp(e,t,i){return e+i*(t-e)}static invLerp(e,t,i){return(i-e)/(t-e)}static floorToPlace(e,t){if(t===0)return Math.floor(e);let i=10;for(;t>1;)t--;return Math.floor(e*i)/i}static fromHex(e){return parseInt(e,16)}static toHex(e,t=null){let i=1;for(;i*16<e;)i*=16;let s="";for(;i>=1;){let a=Math.floor(e/i);s+=w.toHexDigit(a),e-=a*i,i/=16}if(t!==null)for(;s.length<t;)s="0"+s;return s}static toHexDigit(e){return e<10?""+e:String.fromCharCode(65+e-10)}}class r{constructor(e=0,t=0){this.onChange=()=>{},this.vec=new Float32Array(2),this.vec[0]=e,this.vec[1]=t}get x(){return this.vec[0]}set x(e){this.vec[0]=e,this.onChange&&this.onChange()}get y(){return this.vec[1]}set y(e){this.vec[1]=e,this.onChange&&this.onChange()}static get ZERO(){return new r(0,0)}static get INF(){return new r(1/0,1/0)}static get UP(){return new r(0,-1)}static get DOWN(){return new r(0,1)}static get LEFT(){return new r(-1,0)}static get RIGHT(){return new r(1,0)}magSq(){return this.x*this.x+this.y*this.y}mag(){return Math.sqrt(this.magSq())}normalize(){if(this.x===0&&this.y===0)return this;let e=this.mag();return this.x/=e,this.y/=e,this}normalized(){if(this.isZero())return this;let e=this.mag();return new r(this.x/e,this.y/e)}zero(){return this.set(0,0)}setToAngle(e,t=1){return this.x=w.floorToPlace(Math.cos(e)*t,5),this.y=w.floorToPlace(-Math.sin(e)*t,5),this}vecTo(e){return new r(e.x-this.x,e.y-this.y)}dirTo(e){return this.vecTo(e).normalize()}scaleTo(e){return this.normalize().scale(e)}scale(e,t=null){return t!==null?(this.x*=e,this.y*=t,this):(this.x*=e,this.y*=e,this)}scaled(e,t=null){return this.clone().scale(e,t)}rotateCCW(e){let t=Math.cos(e),i=Math.sin(e),s=this.x*t-this.y*i,a=this.x*i+this.y*t;return this.x=s,this.y=a,this}set(e,t){return this.x=e,this.y=t,this}copy(e){return this.set(e.x,e.y)}add(e){return this.x+=e.x,this.y+=e.y,this}inc(e,t){return t===void 0?(this.x+=e,this.y+=e):(this.x+=e,this.y+=t),this}sub(e){return this.x-=e.x,this.y-=e.y,this}mult(e){return this.x*=e.x,this.y*=e.y,this}div(e){if(e.x===0||e.y===0)throw"Divide by zero error";return this.x/=e.x,this.y/=e.y,this}remainder(e){return this.x=this.x%e.x,this.y=this.y%e.y,this}distanceSqTo(e){return(this.x-e.x)*(this.x-e.x)+(this.y-e.y)*(this.y-e.y)}distanceTo(e){return Math.sqrt(this.distanceSqTo(e))}dot(e){return this.x*e.x+this.y*e.y}angleToCCW(e){let t=this.dot(e),i=this.x*e.y-this.y*e.x,s=-Math.atan2(i,t);return s<0&&(s+=2*Math.PI),s}toString(){return this.toFixed()}toFixed(e=1){return"("+this.x.toFixed(e)+", "+this.y.toFixed(e)+")"}clone(){return new r(this.x,this.y)}strictEquals(e){return this.x===e.x&&this.y===e.y}equals(e){let t=Math.abs(this.x-e.x)<1e-7,i=Math.abs(this.y-e.y)<1e-7;return t&&i}strictIsZero(){return this.x===0&&this.y===0}isZero(){return Math.abs(this.x)<1e-7&&Math.abs(this.y)<1e-7}setOnChange(e){this.onChange=e}toArray(){return this.vec}static lerp(e,t,i){return new r(w.lerp(e.x,t.x,i),w.lerp(e.y,t.y,i))}}r.ZERO_STATIC=new r(0,0);class l{static initialize(e,t){l.viewport=e,l.mousePressed=!1,l.mouseJustPressed=!1,l.receiver=new ye,l.keyJustPressed=new L,l.keyPressed=new L,l.mousePosition=new r(0,0),l.mousePressPosition=new r(0,0),l.scrollDirection=0,l.justScrolled=!1,l.keysDisabled=!1,l.mouseDisabled=!1,l.keyMap=new L;for(let i in t){let s=t[i].name,a=t[i].keys;l.keyMap.add(s,a)}l.eventQueue=te.getInstance(),l.eventQueue.subscribe(l.receiver,[p.MOUSE_DOWN,p.MOUSE_UP,p.MOUSE_MOVE,p.KEY_DOWN,p.KEY_UP,p.CANVAS_BLUR,p.WHEEL_UP,p.WHEEL_DOWN])}static changeKeyMap(e){l.keyMap=new L;for(const t in e){const i=e[t].name,s=e[t].keys;l.keyMap.add(i,s)}}static update(e){for(l.mouseJustPressed=!1,l.keyJustPressed.forEach(t=>l.keyJustPressed.set(t,!1)),l.justScrolled=!1,l.scrollDirection=0;l.receiver.hasNextEvent();){let t=l.receiver.getNextEvent();if(t.type===p.MOUSE_DOWN&&(l.mouseJustPressed=!0,l.mousePressed=!0,l.mousePressPosition=t.data.get("position"),l.mouseButtonPressed=t.data.get("button")),t.type===p.MOUSE_UP&&(l.mousePressed=!1),t.type===p.MOUSE_MOVE&&(l.mousePosition=t.data.get("position")),t.type===p.KEY_DOWN){let i=t.data.get("key");i===" "&&(i="space"),l.keyPressed.get(i)||(l.keyJustPressed.set(i,!0),l.keyPressed.set(i,!0))}if(t.type===p.KEY_UP){let i=t.data.get("key");i===" "&&(i="space"),l.keyPressed.set(i,!1)}t.type===p.CANVAS_BLUR&&l.clearKeyPresses(),t.type===p.WHEEL_UP?(l.scrollDirection=-1,l.justScrolled=!0):t.type===p.WHEEL_DOWN&&(l.scrollDirection=1,l.justScrolled=!0)}}static clearKeyPresses(){l.keyJustPressed.forEach(e=>l.keyJustPressed.set(e,!1)),l.keyPressed.forEach(e=>l.keyPressed.set(e,!1))}static isKeyJustPressed(e){return l.keysDisabled?!1:l.keyJustPressed.has(e)?l.keyJustPressed.get(e):!1}static getKeysJustPressed(){if(l.keysDisabled)return[];let e=Array();return l.keyJustPressed.forEach(t=>{l.keyJustPressed.get(t)&&e.push(t)}),e}static isKeyPressed(e){return l.keysDisabled?!1:l.keyPressed.has(e)?l.keyPressed.get(e):!1}static changeKeyBinding(e,t){l.keyMap.set(e,t)}static clearAllKeyBindings(){l.keyMap.clear()}static isJustPressed(e){if(l.keysDisabled)return!1;if(l.keyMap.has(e)){const t=l.keyMap.get(e);let i=!1;for(let s of t)i=i||l.isKeyJustPressed(s);return i}else return!1}static isPressed(e){if(l.keysDisabled)return!1;if(l.keyMap.has(e)){const t=l.keyMap.get(e);let i=!1;for(let s of t)i=i||l.isKeyPressed(s);return i}else return!1}static isMouseJustPressed(e){return e?l.mouseJustPressed&&!l.mouseDisabled&&e==this.mouseButtonPressed:l.mouseJustPressed&&!l.mouseDisabled}static isMousePressed(e){return e?l.mousePressed&&!l.mouseDisabled&&e==this.mouseButtonPressed:l.mousePressed&&!l.mouseDisabled}static didJustScroll(){return l.justScrolled&&!l.mouseDisabled}static getScrollDirection(){return l.scrollDirection}static getMousePosition(){return l.mousePosition.scaled(1/this.viewport.getZoomLevel())}static getGlobalMousePosition(){return l.mousePosition.clone().scale(1/this.viewport.getZoomLevel()).add(l.viewport.getOrigin())}static getMousePressPosition(){return l.mousePressPosition}static getGlobalMousePressPosition(){return l.mousePressPosition.clone().add(l.viewport.getOrigin())}static disableInput(){l.keysDisabled=!0}static enableInput(){l.keysDisabled=!1}}class re{constructor(e,t=null){if(t===null)this.data=new L;else if(t instanceof L)this.data=t;else{this.data=new L;for(let i in t)this.data.add(i,t[i])}this.type=e,this.time=Date.now()}isType(e){return this.type===e}toString(){return this.type+": @"+this.time}}class Vt{constructor(e){this.handleMouseDown=(t,i)=>{let s=this.getMousePosition(t,i),a=t.button,o=new re(p.MOUSE_DOWN,{position:s,button:a});this.eventQueue.addEvent(o)},this.handleMouseUp=(t,i)=>{let s=this.getMousePosition(t,i),a=new re(p.MOUSE_UP,{position:s});this.eventQueue.addEvent(a)},this.handleMouseMove=(t,i)=>{let s=this.getMousePosition(t,i),a=new re(p.MOUSE_MOVE,{position:s});this.eventQueue.addEvent(a)},this.handleKeyDown=t=>{let i=this.getKey(t),s=new re(p.KEY_DOWN,{key:i});this.eventQueue.addEvent(s)},this.handleKeyUp=t=>{let i=this.getKey(t),s=new re(p.KEY_UP,{key:i});this.eventQueue.addEvent(s)},this.handleBlur=t=>{let i=new re(p.CANVAS_BLUR,{});this.eventQueue.addEvent(i)},this.handleContextMenu=t=>{t.preventDefault(),t.stopPropagation()},this.handleWheel=t=>{t.preventDefault(),t.stopPropagation();let i;t.deltaY<0?i=new re(p.WHEEL_UP,{}):i=new re(p.WHEEL_DOWN,{}),this.eventQueue.addEvent(i)},this.eventQueue=te.getInstance(),e.onmousedown=t=>this.handleMouseDown(t,e),e.onmouseup=t=>this.handleMouseUp(t,e),e.oncontextmenu=this.handleContextMenu,e.onmousemove=t=>this.handleMouseMove(t,e),document.onkeydown=this.handleKeyDown,document.onkeyup=this.handleKeyUp,document.onblur=this.handleBlur,document.oncontextmenu=this.handleBlur,document.onwheel=this.handleWheel}getKey(e){return e.key.toLowerCase()}getMousePosition(e,t){let i=t.getBoundingClientRect(),s=e.clientX-i.left,a=e.clientY-i.top;return new r(s,a)}}class Qt{constructor(){this.receiver=new ye,this.log=new Z(1e3),this.recording=!1,this.playing=!1,this.frame=0,this.eventQueue=te.getInstance(),this.eventQueue.subscribe(this.receiver,"all")}update(e){if(this.recording&&(this.frame+=1),this.playing){for(this.receiver.ignoreEvents();this.log.hasItems()&&this.log.peekNext().frame*this.log.peekNext().delta<this.frame*e;){let t=this.log.dequeue().event;console.log(t),this.eventQueue.addEvent(t)}this.log.hasItems()||(this.playing=!1),this.frame+=1}else for(;this.receiver.hasNextEvent();){let t=this.receiver.getNextEvent();t.type===p.STOP_RECORDING&&(this.recording=!1),this.recording&&this.log.enqueue(new Xt(this.frame,e,t)),t.type===p.START_RECORDING&&(this.log.clear(),this.recording=!0,this.frame=0),t.type===p.PLAY_RECORDING&&(this.frame=0,this.recording=!1,this.playing=!0)}}}class Xt{constructor(e,t,i){this.frame=e,this.delta=t,this.event=i}}class g{constructor(e=0,t=0,i=0,s=1){this.r=e,this.g=t,this.b=i,this.a=s}static get TRANSPARENT(){return new g(0,0,0,0)}static get RED(){return new g(255,0,0,1)}static get GREEN(){return new g(0,255,0,1)}static get BLUE(){return new g(0,0,255,1)}static get YELLOW(){return new g(255,255,0,1)}static get MAGENTA(){return new g(255,0,255,1)}static get CYAN(){return new g(0,255,255,1)}static get WHITE(){return new g(255,255,255,1)}static get BLACK(){return new g(0,0,0,1)}static get ORANGE(){return new g(255,100,0,1)}set(e,t,i,s=1){this.r=e,this.g=t,this.b=i,this.a=s}lighten(){return new g(w.clamp(this.r+40,0,255),w.clamp(this.g+40,0,255),w.clamp(this.b+40,0,255),w.clamp(this.a+10,0,255))}darken(){return new g(w.clamp(this.r-40,0,255),w.clamp(this.g-40,0,255),w.clamp(this.b-40,0,255),w.clamp(this.a+10,0,255))}toArray(){return[this.r,this.g,this.b,this.a]}toString(){return"#"+w.toHex(this.r,2)+w.toHex(this.g,2)+w.toHex(this.b,2)}toStringRGB(){return"rgb("+this.r.toString()+", "+this.g.toString()+", "+this.b.toString()+")"}toStringRGBA(){return this.a===0?this.toStringRGB():"rgba("+this.r.toString()+", "+this.g.toString()+", "+this.b.toString()+", "+this.a.toString()+")"}toWebGL(){return new Float32Array([this.r/255,this.g/255,this.b/255,this.a])}static fromStringHex(e){let t=0;e.charAt(0)=="#"&&(t+=1);let i=w.fromHex(e.substring(t,t+2)),s=w.fromHex(e.substring(t+2,t+4)),a=w.fromHex(e.substring(t+4,t+6));return new g(i,s,a)}}class F{static log(e,...t){let i=t.map(s=>s.toString()).join(" ");this.logMessages.add(e,i)}static clearLogItem(e){this.logMessages.delete(e)}static setNodes(e){this.nodes=e}static drawBox(e,t,i,s){let a=this.debugRenderingContext.globalAlpha;if(this.debugRenderingContext.globalAlpha=s.a,i)this.debugRenderingContext.fillStyle=s.toString(),this.debugRenderingContext.fillRect(e.x-t.x,e.y-t.y,t.x*2,t.y*2);else{let o=2;this.debugRenderingContext.lineWidth=o,this.debugRenderingContext.strokeStyle=s.toString(),this.debugRenderingContext.strokeRect(e.x-t.x,e.y-t.y,t.x*2,t.y*2)}this.debugRenderingContext.globalAlpha=a}static drawCircle(e,t,i,s){let a=this.debugRenderingContext.globalAlpha;if(this.debugRenderingContext.globalAlpha=s.a,i)this.debugRenderingContext.fillStyle=s.toString(),this.debugRenderingContext.beginPath(),this.debugRenderingContext.arc(e.x,e.y,t,0,2*Math.PI),this.debugRenderingContext.closePath(),this.debugRenderingContext.fill();else{let o=2;this.debugRenderingContext.lineWidth=o,this.debugRenderingContext.strokeStyle=s.toString(),this.debugRenderingContext.beginPath(),this.debugRenderingContext.arc(e.x,e.y,t,0,2*Math.PI),this.debugRenderingContext.closePath(),this.debugRenderingContext.stroke()}this.debugRenderingContext.globalAlpha=a}static drawRay(e,t,i){this.debugRenderingContext.lineWidth=2,this.debugRenderingContext.strokeStyle=i.toString(),this.debugRenderingContext.beginPath(),this.debugRenderingContext.moveTo(e.x,e.y),this.debugRenderingContext.lineTo(t.x,t.y),this.debugRenderingContext.closePath(),this.debugRenderingContext.stroke()}static drawPoint(e,t){let i=6;this.debugRenderingContext.fillStyle=t.toString(),this.debugRenderingContext.fillRect(e.x-i/2,e.y-i/2,i,i)}static setDefaultTextColor(e){this.defaultTextColor=e}static initializeDebugCanvas(e,t,i){return e.width=t,e.height=i,this.debugCanvasSize=new r(t,i),this.debugRenderingContext=e.getContext("2d"),this.debugRenderingContext}static clearCanvas(){this.debugRenderingContext.clearRect(0,0,this.debugCanvasSize.x,this.debugCanvasSize.y)}static render(){this.renderText(),this.renderNodes()}static renderText(){let e=20;this.debugRenderingContext.font="20px Arial",this.debugRenderingContext.fillStyle=this.defaultTextColor.toString(),this.logMessages.forEach(t=>{this.debugRenderingContext.fillText(this.logMessages.get(t),10,e),e+=30})}static renderNodes(){this.nodes&&this.nodes.forEach(e=>{e.debugRender()})}}F.logMessages=new L;F.defaultTextColor=g.WHITE;class et{static getPathFromFilePath(e){let t=e.split("/");return t.pop(),t.push(""),t.join("/")}}class Me{constructor(){this.initAudio(),this.receiver=new ye,this.receiver.subscribe([p.PLAY_SOUND,p.STOP_SOUND,p.PLAY_MUSIC,p.PLAY_SFX,p.MUTE_CHANNEL,p.UNMUTE_CHANNEL]),this.currentSounds=new L,this.gainNodes=new Array(St),this.initGainNodes()}static getInstance(){return this.instance||(this.instance=new Me),this.instance}initAudio(){try{window.AudioContext=window.AudioContext,this.audioCtx=new AudioContext,console.log("Web Audio API successfully loaded")}catch{console.warn("Web Audio API is not supported in this browser")}}initGainNodes(){for(let e=0;e<St;e++)this.gainNodes[e]=this.audioCtx.createGain()}getAudioContext(){return this.audioCtx}createSound(e,t,i,s){let a=D.getInstance().getAudio(e);var o=this.audioCtx.createBufferSource();o.buffer=a;const d=[o];d.push(this.gainNodes[i]);for(let h=1;h<d.length;h++)d[h-1].connect(d[h]);return d[d.length-1].connect(this.audioCtx.destination),o}playSound(e,t,i,s,a){let o=this.createSound(e,i,s,a);t&&(o.loop=!0),i&&this.currentSounds.add(e,o),o.start()}stopSound(e){let t=this.currentSounds.get(e);t&&(t.stop(),this.currentSounds.delete(e))}muteChannel(e){this.gainNodes[e].gain.setValueAtTime(0,this.audioCtx.currentTime)}unmuteChannel(e){this.gainNodes[e].gain.setValueAtTime(1,this.audioCtx.currentTime)}static setVolume(e,t){t<0&&(t=0);const i=Me.getInstance();i.gainNodes[e].gain.setValueAtTime(t,i.audioCtx.currentTime)}getChannelGainNode(e){return this.gainNodes[e]}update(e){for(;this.receiver.hasNextEvent();){let t=this.receiver.getNextEvent();if(t.type===p.PLAY_SOUND||t.type===p.PLAY_MUSIC||t.type===p.PLAY_SFX){let i=t.data.get("key"),s=t.data.get("loop"),a=t.data.get("holdReference"),o=Ce.DEFAULT;t.type===p.PLAY_MUSIC?o=Ce.MUSIC:p.PLAY_SFX?o=Ce.SFX:t.data.has("channel")&&(o=t.data.get("channel")),this.playSound(i,s,a,o,t.data)}if(t.type===p.STOP_SOUND){let i=t.data.get("key");this.stopSound(i)}t.type===p.MUTE_CHANNEL&&this.muteChannel(t.data.get("channel")),t.type===p.UNMUTE_CHANNEL&&this.unmuteChannel(t.data.get("channel"))}}}var Ce;(function(n){n[n.DEFAULT=0]="DEFAULT",n[n.SFX=1]="SFX",n[n.MUSIC=2]="MUSIC",n[n.CUSTOM_1=3]="CUSTOM_1",n[n.CUSTOM_2=4]="CUSTOM_2",n[n.CUSTOM_3=5]="CUSTOM_3",n[n.CUSTOM_4=6]="CUSTOM_4",n[n.CUSTOM_5=7]="CUSTOM_5",n[n.CUSTOM_6=8]="CUSTOM_6",n[n.CUSTOM_7=9]="CUSTOM_7",n[n.CUSTOM_8=10]="CUSTOM_8",n[n.CUSTOM_9=11]="CUSTOM_9"})(Ce||(Ce={}));const St=12;class Kt{delete(e){this.program&&e.deleteProgram(this.program),this.vertexShader&&e.deleteShader(this.vertexShader),this.fragmentShader&&e.deleteShader(this.fragmentShader)}}class D{constructor(){this.loading=!1,this.justLoaded=!1,this.loadonly_imagesLoaded=0,this.loadonly_imagesToLoad=0,this.loadonly_imageLoadingQueue=new Z,this.images=new L,this.loadonly_spritesheetsLoaded=0,this.loadonly_spritesheetsToLoad=0,this.loadonly_spritesheetLoadingQueue=new Z,this.spritesheets=new L,this.loadonly_tilemapsLoaded=0,this.loadonly_tilemapsToLoad=0,this.loadonly_tilemapLoadingQueue=new Z,this.tilemaps=new L,this.loadonly_audioLoaded=0,this.loadonly_audioToLoad=0,this.loadonly_audioLoadingQueue=new Z,this.audioBuffers=new L,this.loadonly_jsonLoaded=0,this.loadonly_jsonToLoad=0,this.loadonly_jsonLoadingQueue=new Z,this.jsonObjects=new L,this.loadonly_gl_ShaderProgramsLoaded=0,this.loadonly_gl_ShaderProgramsToLoad=0,this.loadonly_gl_ShaderLoadingQueue=new Z,this.gl_ShaderPrograms=new L,this.gl_Textures=new L,this.gl_NextTextureID=0,this.gl_Buffers=new L,this.resourcesToUnload=new Array,this.resourcesToKeep=new Array}static getInstance(){return this.instance||(this.instance=new D),this.instance}useWebGL(e,t){this.gl_WebGLActive=e,this.gl_WebGLActive&&(this.gl=t)}image(e,t){this.loadonly_imageLoadingQueue.enqueue({key:e,path:t})}keepImage(e){this.keepResource(e,I.IMAGE)}getImage(e){let t=this.images.get(e);if(t===void 0)throw`There is no image associated with key "${e}"`;return t}spritesheet(e,t){this.loadonly_spritesheetLoadingQueue.enqueue({key:e,path:t})}keepSpritesheet(e){this.keepResource(e,I.SPRITESHEET)}getSpritesheet(e){return this.spritesheets.get(e)}audio(e,t){this.loadonly_audioLoadingQueue.enqueue({key:e,path:t})}keepAudio(e){this.keepResource(e,I.AUDIO)}getAudio(e){return this.audioBuffers.get(e)}tilemap(e,t){this.loadonly_tilemapLoadingQueue.enqueue({key:e,path:t})}keepTilemap(e){this.keepResource(e,I.TILEMAP)}getTilemap(e){return this.tilemaps.get(e)}object(e,t){this.loadonly_jsonLoadingQueue.enqueue({key:e,path:t})}keepObject(e){this.keepResource(e,I.JSON)}getObject(e){return this.jsonObjects.get(e)}loadResourcesFromQueue(e){this.loadonly_typesToLoad=5,this.loading=!0,this.loadTilemapsFromQueue(()=>{console.log("Loaded Tilemaps"),this.loadSpritesheetsFromQueue(()=>{console.log("Loaded Spritesheets"),this.loadImagesFromQueue(()=>{console.log("Loaded Images"),this.loadAudioFromQueue(()=>{console.log("Loaded Audio"),this.loadObjectsFromQueue(()=>{console.log("Loaded Objects"),this.gl_WebGLActive?this.gl_LoadShadersFromQueue(()=>{console.log("Loaded Shaders"),this.finishLoading(e)}):this.finishLoading(e)})})})})})}finishLoading(e){this.loading=!1,this.justLoaded=!0,e()}keepResource(e,t){console.log("Keep resource...");for(let i=0;i<this.resourcesToUnload.length;i++){let s=this.resourcesToUnload[i];if(s.key===e&&s.resourceType===t){console.log("Found resource "+e+" of type "+t+". Keeping.");let a=this.resourcesToUnload.splice(i,1);this.resourcesToKeep.push(...a);return}}}unloadAllResources(){this.loading=!1,this.justLoaded=!1;for(let e of this.resourcesToUnload)this.unloadResource(e)}unloadResource(e){switch(e.resourceType){case I.IMAGE:this.images.delete(e.key),this.gl_WebGLActive&&this.gl_Textures.delete(e.key);break;case I.TILEMAP:this.tilemaps.delete(e.key);break;case I.SPRITESHEET:this.spritesheets.delete(e.key);break;case I.AUDIO:this.audioBuffers.delete(e.key);break;case I.JSON:this.jsonObjects.delete(e.key);break}for(let t of e.dependencies)this.unloadResource(t)}loadTilemapsFromQueue(e){if(this.loadonly_tilemapsToLoad=this.loadonly_tilemapLoadingQueue.getSize(),this.loadonly_tilemapsLoaded=0,this.loadonly_tilemapsToLoad===0){e();return}for(;this.loadonly_tilemapLoadingQueue.hasItems();){let t=this.loadonly_tilemapLoadingQueue.dequeue();this.loadTilemap(t.key,t.path,e)}}loadTilemap(e,t,i){this.loadTextFile(t,s=>{let a=JSON.parse(s);this.tilemaps.add(e,a);let o=new ae(e,I.TILEMAP);for(let d of a.tilesets)if(d.image){let h=d.image,c=et.getPathFromFilePath(t)+h;this.loadonly_imageLoadingQueue.enqueue({key:h,path:c,isDependency:!0}),o.addDependency(new ae(h,I.IMAGE))}else if(d.tiles)for(let h of d.tiles){let c=h.image,u=et.getPathFromFilePath(t)+c;this.loadonly_imageLoadingQueue.enqueue({key:c,path:u,isDependency:!0}),o.addDependency(new ae(c,I.IMAGE))}this.resourcesToUnload.push(o),this.finishLoadingTilemap(i)})}finishLoadingTilemap(e){this.loadonly_tilemapsLoaded+=1,this.loadonly_tilemapsLoaded===this.loadonly_tilemapsToLoad&&e()}loadSpritesheetsFromQueue(e){if(this.loadonly_spritesheetsToLoad=this.loadonly_spritesheetLoadingQueue.getSize(),this.loadonly_spritesheetsLoaded=0,this.loadonly_spritesheetsToLoad===0){e();return}for(;this.loadonly_spritesheetLoadingQueue.hasItems();){let t=this.loadonly_spritesheetLoadingQueue.dequeue();this.loadSpritesheet(t.key,t.path,e)}}loadSpritesheet(e,t,i){this.loadTextFile(t,s=>{let a=JSON.parse(s);this.spritesheets.add(e,a);let o=new ae(e,I.SPRITESHEET),d=et.getPathFromFilePath(t)+a.spriteSheetImage;this.loadonly_imageLoadingQueue.enqueue({key:a.name,path:d,isDependency:!0}),o.addDependency(new ae(a.name,I.IMAGE)),this.resourcesToUnload.push(o),this.finishLoadingSpritesheet(i)})}finishLoadingSpritesheet(e){this.loadonly_spritesheetsLoaded+=1,this.loadonly_spritesheetsLoaded===this.loadonly_spritesheetsToLoad&&e()}loadImagesFromQueue(e){if(this.loadonly_imagesToLoad=this.loadonly_imageLoadingQueue.getSize(),this.loadonly_imagesLoaded=0,this.loadonly_imagesToLoad===0){e();return}for(;this.loadonly_imageLoadingQueue.hasItems();){let t=this.loadonly_imageLoadingQueue.dequeue();this.loadImage(t.key,t.path,t.isDependency,e)}}loadImage(e,t,i,s){var a=new Image;a.onload=()=>{this.images.add(e,a),i||this.resourcesToUnload.push(new ae(e,I.IMAGE)),this.gl_WebGLActive&&this.createWebGLTexture(e,a),this.finishLoadingImage(s)},a.src=t}finishLoadingImage(e){this.loadonly_imagesLoaded+=1,this.loadonly_imagesLoaded===this.loadonly_imagesToLoad&&e()}loadAudioFromQueue(e){if(this.loadonly_audioToLoad=this.loadonly_audioLoadingQueue.getSize(),this.loadonly_audioLoaded=0,this.loadonly_audioToLoad===0){e();return}for(;this.loadonly_audioLoadingQueue.hasItems();){let t=this.loadonly_audioLoadingQueue.dequeue();this.loadAudio(t.key,t.path,e)}}loadAudio(e,t,i){let s=Me.getInstance().getAudioContext(),a=new XMLHttpRequest;a.open("GET",t,!0),a.responseType="arraybuffer",a.onload=()=>{s.decodeAudioData(a.response,o=>{this.audioBuffers.add(e,o),this.resourcesToUnload.push(new ae(e,I.AUDIO)),this.finishLoadingAudio(i)},o=>{throw"Error loading sound"})},a.send()}finishLoadingAudio(e){this.loadonly_audioLoaded+=1,this.loadonly_audioLoaded===this.loadonly_audioToLoad&&e()}loadObjectsFromQueue(e){if(this.loadonly_jsonToLoad=this.loadonly_jsonLoadingQueue.getSize(),this.loadonly_jsonLoaded=0,this.loadonly_jsonToLoad===0){e();return}for(;this.loadonly_jsonLoadingQueue.hasItems();){let t=this.loadonly_jsonLoadingQueue.dequeue();this.loadObject(t.key,t.path,e)}}loadObject(e,t,i){this.loadTextFile(t,s=>{let a=JSON.parse(s);this.jsonObjects.add(e,a),this.resourcesToUnload.push(new ae(e,I.JSON)),this.finishLoadingObject(i)})}finishLoadingObject(e){this.loadonly_jsonLoaded+=1,this.loadonly_jsonLoaded===this.loadonly_jsonToLoad&&e()}getTexture(e){return this.gl_Textures.get(e)}getShaderProgram(e){return this.gl_ShaderPrograms.get(e).program}getBuffer(e){return this.gl_Buffers.get(e)}createWebGLTexture(e,t){const i=this.getTextureID(this.gl_NextTextureID),s=this.gl.createTexture();this.gl.activeTexture(i),this.gl.bindTexture(this.gl.TEXTURE_2D,s),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl_Textures.add(e,this.gl_NextTextureID),this.gl_NextTextureID+=1}getTextureID(e){switch(e){case 0:return this.gl.TEXTURE0;case 1:return this.gl.TEXTURE1;case 2:return this.gl.TEXTURE2;case 3:return this.gl.TEXTURE3;case 4:return this.gl.TEXTURE4;case 5:return this.gl.TEXTURE5;case 6:return this.gl.TEXTURE6;case 7:return this.gl.TEXTURE7;case 8:return this.gl.TEXTURE8;default:return this.gl.TEXTURE9}}createBuffer(e){if(this.gl_WebGLActive){let t=this.gl.createBuffer();this.gl_Buffers.add(e,t)}}shader(e,t,i){let s=t.split("."),a=s[s.length-1];if(a!=="vshader")throw`${t} is not a valid vertex shader - must end in ".vshader`;if(s=i.split("."),a=s[s.length-1],a!=="fshader")throw`${i} is not a valid vertex shader - must end in ".fshader`;let o=new qt;o.key=e,o.vpath=t,o.fpath=i,this.loadonly_gl_ShaderLoadingQueue.enqueue(o)}keepShader(e){this.keepResource(e,I.IMAGE)}gl_LoadShadersFromQueue(e){if(this.loadonly_gl_ShaderProgramsToLoad=this.loadonly_gl_ShaderLoadingQueue.getSize(),this.loadonly_gl_ShaderProgramsLoaded=0,!this.gl_WebGLActive||this.loadonly_gl_ShaderProgramsToLoad===0){e();return}for(;this.loadonly_gl_ShaderLoadingQueue.hasItems();){let t=this.loadonly_gl_ShaderLoadingQueue.dequeue();this.gl_LoadShader(t.key,t.vpath,t.fpath,e)}}gl_LoadShader(e,t,i,s){this.loadTextFile(t,a=>{const o=a;this.loadTextFile(i,d=>{const h=d,[c,u,y]=this.createShaderProgram(o,h),m=new Kt;m.program=c,m.vertexShader=u,m.fragmentShader=y,this.gl_ShaderPrograms.add(e,m),this.resourcesToUnload.push(new ae(e,I.SHADER)),this.gl_FinishLoadingShader(s)})})}gl_FinishLoadingShader(e){this.loadonly_gl_ShaderProgramsLoaded+=1,this.loadonly_gl_ShaderProgramsLoaded===this.loadonly_gl_ShaderProgramsToLoad&&e()}createShaderProgram(e,t){const i=this.loadVertexShader(e),s=this.loadFragmentShader(t);if(i===null||s===null)return null;const a=this.gl.createProgram();if(!a)return console.warn("Failed to create program"),null;if(this.gl.attachShader(a,i),this.gl.attachShader(a,s),this.gl.linkProgram(a),!this.gl.getProgramParameter(a,this.gl.LINK_STATUS)){const o=this.gl.getProgramInfoLog(a);return console.warn("Failed to link program: "+o),this.gl.deleteProgram(a),this.gl.deleteShader(i),this.gl.deleteShader(s),null}return[a,i,s]}loadVertexShader(e){return this.loadShader(this.gl.VERTEX_SHADER,e)}loadFragmentShader(e){return this.loadShader(this.gl.FRAGMENT_SHADER,e)}loadShader(e,t){const i=this.gl.createShader(e);if(i===null)return console.warn("Unable to create shader"),null;if(this.gl.shaderSource(i,t),this.gl.compileShader(i),!this.gl.getShaderParameter(i,this.gl.COMPILE_STATUS)){const s=this.gl.getShaderInfoLog(i);return console.warn("Failed to compile shader: "+s),this.gl.deleteShader(i),null}return i}loadTextFile(e,t){let i=new XMLHttpRequest;i.overrideMimeType("application/json"),i.open("GET",e,!0),i.onreadystatechange=function(){i.readyState==4&&i.status==200&&t(i.responseText)},i.send(null)}getLoadPercent(){return(this.loadonly_tilemapsLoaded/this.loadonly_tilemapsToLoad+this.loadonly_spritesheetsLoaded/this.loadonly_spritesheetsToLoad+this.loadonly_imagesLoaded/this.loadonly_imagesToLoad+this.loadonly_audioLoaded/this.loadonly_audioToLoad)/this.loadonly_typesToLoad}update(e){this.loading?this.onLoadProgress&&this.onLoadProgress(this.getLoadPercent()):this.justLoaded&&(this.justLoaded=!1,this.onLoadComplete&&this.onLoadComplete())}}class ae{constructor(e,t){this.key=e,this.resourceType=t,this.dependencies=new Array}addDependency(e){this.dependencies.push(e)}}var I;(function(n){n.IMAGE="IMAGE",n.TILEMAP="TILEMAP",n.SPRITESHEET="SPRITESHEET",n.AUDIO="AUDIO",n.JSON="JSON",n.SHADER="SHADER"})(I||(I={}));class qt{}class We{get x(){return this.center.x}get y(){return this.center.y}get hw(){return this.halfSize.x}get hh(){return this.halfSize.y}get top(){return this.y-this.hh}get bottom(){return this.y+this.hh}get left(){return this.x-this.hw}get right(){return this.x+this.hw}static getTimeOfCollision(e,t,i,s){if(e instanceof z&&i instanceof z)return We.getTimeOfCollision_AABB_AABB(e,t,i,s)}static getTimeOfCollision_AABB_AABB(e,t,i,s){let a=e.center,o=i.center,d=e.halfSize,h=i.halfSize,c=new r(0,0),u=new r(0,0),y=!1,m=!1;if(o.x<a.x){let f;f=d,d=h,h=f,f=a,a=o,o=f,f=t,t=s,s=f}if(c.x=1/0,u.x=1/0,o.x-h.x>=a.x+d.x){let f=t.x-s.x;f>0&&(c.x=(o.x-h.x-(a.x+d.x))/f,u.x=(o.x+h.x-(a.x-d.x))/f)}else y=!0;if(o.y<a.y){let f;f=d,d=h,h=f,f=a,a=o,o=f,f=t,t=s,s=f}if(c.y=1/0,u.y=1/0,o.y-h.y>=a.y+d.y){let f=t.y-s.y;f>0&&(c.y=(o.y-h.y-(a.y+d.y))/f,u.y=(o.y+h.y-(a.y-d.y))/f)}else m=!0;return[c,u,y,m]}}class Ye extends We{constructor(e,t){super(),this._center=e||new r(0,0),this.radius=t||0}get center(){return this._center}set center(e){this._center=e}get halfSize(){return new r(this.radius,this.radius)}get r(){return this.radius}set r(e){this.radius=e}containsPoint(e){return this.center.distanceSqTo(e)<=this.radius*this.radius}getBoundingRect(){return new z(this._center.clone(),new r(this.radius,this.radius))}getBoundingCircle(){return this.clone()}overlaps(e){throw new Error("Method not implemented.")}clone(){return new Ye(this._center.clone(),this.radius)}toString(){return"(center: "+this.center.toString()+", radius: "+this.radius+")"}}class Zt{constructor(){this.nearTimes=r.ZERO,this.pos=r.ZERO,this.delta=r.ZERO,this.normal=r.ZERO}}class z extends We{constructor(e,t){super(),this.center=e||new r(0,0),this.halfSize=t||new r(0,0)}get topLeft(){return new r(this.left,this.top)}get topRight(){return new r(this.right,this.top)}get bottomLeft(){return new r(this.left,this.bottom)}get bottomRight(){return new r(this.right,this.bottom)}getBoundingRect(){return this.clone()}getBoundingCircle(){let e=Math.max(this.hw,this.hh);return new Ye(this.center.clone(),e)}getHalfSize(){return this.halfSize}setHalfSize(e){this.halfSize=e}containsPoint(e){return e.x>=this.x-this.hw&&e.x<=this.x+this.hw&&e.y>=this.y-this.hh&&e.y<=this.y+this.hh}intersectPoint(e){let t=e.x-this.x;if(this.hw-Math.abs(t)<=0)return!1;let s=e.y-this.y;return!(this.hh-Math.abs(s)<=0)}containsPointSoft(e){return e.x>this.x-this.hw&&e.x<=this.x+this.hw&&e.y>this.y-this.hh&&e.y<=this.y+this.hh}intersectSegment(e,t,i){let s=i?i.x:0,a=i?i.y:0,o=1/t.x,d=1/t.y,h=w.sign(o),c=w.sign(d),u=o*(this.x-h*(this.hw+s)-e.x),y=d*(this.y-c*(this.hh+a)-e.y),m=o*(this.x+h*(this.hw+s)-e.x),f=d*(this.y+c*(this.hh+a)-e.y);if(u>f||y>m)return null;let A=Math.max(u,y);u!==u?A=y:y!==y&&(A=u);let T=Math.min(m,f);if(A===-1/0||A>=1||T<=0)return null;let S=new Zt;return S.time=w.clamp01(A),S.nearTimes.x=u,S.nearTimes.y=y,u>y?(S.normal.x=-h,S.normal.y=0):Math.abs(u-y)<1e-4?(S.normal.x=-h,S.normal.y=-c,S.normal.normalize()):(S.normal.x=0,S.normal.y=-c),S.delta.x=(1-S.time)*-t.x,S.delta.y=(1-S.time)*-t.y,S.pos.x=e.x+t.x*S.time,S.pos.y=e.y+t.y*S.time,S}overlaps(e){if(e instanceof z)return this.overlapsAABB(e);throw"Overlap not defined between these shapes."}overlapsAABB(e){let t=e.x-this.x;if(this.hw+e.hw-Math.abs(t)<=0)return!1;let s=e.y-this.y;return!(this.hh+e.hh-Math.abs(s)<=0)}touchesAABB(e){let t=e.x-this.x,i=this.hw+e.hw-Math.abs(t),s=e.y-this.y,a=this.hh+e.hh-Math.abs(s);if(i===0&&a>=0||a===0&&i>=0){let o=new r;return i===0&&(o.x=e.x<this.x?-1:1),a===0&&(o.y=e.y<this.y?-1:1),o}else return null}touchesAABBWithoutCorners(e){let t=e.x-this.x,i=this.hw+e.hw-Math.abs(t),s=e.y-this.y,a=this.hh+e.hh-Math.abs(s);if(i===0&&a>0||a===0&&i>0){let o=new r;return i===0?o.x=e.x<this.x?-1:1:o.y=e.y<this.y?-1:1,o}else return null}overlapArea(e){let t=Math.max(this.x-this.hw,e.x-e.hw),s=Math.min(this.x+this.hw,e.x+e.hw)-t,a=Math.max(this.y-this.hh,e.y-e.hh),d=Math.min(this.y+this.hh,e.y+e.hh)-a;return s<0||d<0?0:s*d}sweep(e,t,i){t||(t=this.center),i||(i=this.halfSize);let s=t.x+e.x/2,a=t.y+e.y/2,o=Math.min(t.x-i.x,t.x+e.x-i.x),d=Math.min(t.y-i.y,t.y+e.y-i.y);this.center.set(s,a),this.halfSize.set(s-o,a-d)}clone(){return new z(this.center.clone(),this.halfSize.clone())}toString(){return"(center: "+this.center.toString()+", half-size: "+this.halfSize.toString()+")"}}class Ct{constructor(e,t){this.scene=e,this.name=t,this.paused=!1,this.hidden=!1,this.alpha=1,this.items=new Array,this.ySort=!1,this.depth=0}getName(){return this.name}setPaused(e){this.paused=e}isPaused(){return this.paused}setAlpha(e){this.alpha=w.clamp(e,0,1)}getAlpha(){return this.alpha}setHidden(e){this.hidden=e}isHidden(){return this.hidden}disable(){this.paused=!0,this.hidden=!0}enable(){this.paused=!1,this.hidden=!1}setYSort(e){this.ySort=e}getYSort(){return this.ySort}setDepth(e){this.depth=e}getDepth(){return this.depth}addNode(e){this.items.push(e),e.setLayer(this)}removeNode(e){let t=this.items.indexOf(e);t!==-1&&(this.items.splice(t,1),e.setLayer(void 0))}getItems(){return this.items}}class Ie extends Ct{constructor(e,t,i){super(e,t),this.parallax=i}}class st extends Ie{constructor(e,t){super(e,t,r.ZERO)}}class $t{constructor(e,t){this.ZOOM_FACTOR=1.2,this.view=new z(r.ZERO,r.ZERO),this.boundary=new z(r.ZERO,r.ZERO),this.lastPositions=new Z,this.smoothingFactor=10,this.scrollZoomEnabled=!1,this.canvasSize=r.ZERO,this.focus=r.ZERO,this.setCanvasSize(e),this.setSize(e),this.setZoomLevel(t),this.setCenter(this.view.halfSize.clone()),this.setFocus(this.view.halfSize.clone())}enableZoom(){this.scrollZoomEnabled=!0}getCenter(){return this.view.center}getOrigin(){return new r(this.view.left,this.view.top)}getView(){return this.view}setCenter(e,t=null){let i;e instanceof r?i=e:i=new r(e,t),this.view.center=i}getHalfSize(){return this.view.getHalfSize()}setSize(e,t=null){e instanceof r?this.view.setHalfSize(e.scaled(1/2)):this.view.setHalfSize(new r(e/2,t/2))}setHalfSize(e,t=null){e instanceof r?this.view.setHalfSize(e.clone()):this.view.setHalfSize(new r(e,t))}setCanvasSize(e,t=null){e instanceof r?this.canvasSize=e.clone():this.canvasSize=new r(e,t)}setZoomLevel(e){this.view.halfSize.copy(this.canvasSize.scaled(1/e/2))}getZoomLevel(){return this.canvasSize.x/this.view.hw/2}setSmoothingFactor(e){e<0&&(e=0),this.smoothingFactor=e}setFocus(e){this.focus.copy(e)}includes(e){let t=e.getLayer()instanceof Ie||e.getLayer()instanceof st?e.getLayer().parallax:new r(1,1),i=this.view.center.clone();this.view.center.mult(t);let s=this.view.overlaps(e.boundary);return this.view.center=i,s}setBounds(e,t,i,s){let a=(i-e)/2,o=(s-t)/2,d=e+a,h=t+o;this.boundary.center.set(d,h),this.boundary.halfSize.set(a,o)}follow(e){this.following=e}updateView(){this.lastPositions.getSize()>Math.min(this.smoothingFactor,1)&&this.lastPositions.dequeue();let e=r.ZERO;this.smoothingFactor!=0?(this.lastPositions.forEach(t=>e.add(t)),e.scale(1/this.lastPositions.getSize())):this.lastPositions.forEach(t=>e=t),e.x=w.clamp(e.x,this.boundary.left+this.view.hw,this.boundary.right-this.view.hw),e.y=w.clamp(e.y,this.boundary.top+this.view.hh,this.boundary.bottom-this.view.hh),e.x=Math.floor(e.x),e.y=Math.floor(e.y),this.view.center.copy(e)}update(e){if(this.scrollZoomEnabled&&l.didJustScroll()){let t=this.view.getHalfSize().clone();if(l.getScrollDirection()<0?t.scale(1/this.ZOOM_FACTOR):t.scale(this.ZOOM_FACTOR),t.x>this.boundary.hw){let i=this.boundary.hw/t.x;t.x=this.boundary.hw,t.y*=i}if(t.y>this.boundary.hh){let i=this.boundary.hh/t.y;t.y=this.boundary.hh,t.x*=i}this.view.setHalfSize(t)}this.following?this.lastPositions.enqueue(this.following.position.clone()):this.lastPositions.enqueue(this.focus),this.updateView()}}class Jt{constructor(e,t){this.resourceManager=D.getInstance(),this.viewport=e,this.renderingManager=t,this.idCounter=0,this.pendingScene=null}changeToScene(e,t,i){console.log("Creating the new scene - change is pending until next update"),this.pendingScene=new e(this.viewport,this,this.renderingManager,i),this.pendingSceneInit=t}doSceneChange(){console.log("Performing scene change"),this.viewport.setCenter(this.viewport.getHalfSize().x,this.viewport.getHalfSize().y),this.currentScene&&(console.log("Unloading old scene"),this.currentScene.unloadScene(),console.log("Destroying old scene"),this.currentScene.destroy()),console.log("Unloading old resources..."),this.resourceManager.unloadAllResources(),this.currentScene=this.pendingScene,this.pendingScene=null,this.currentScene.initScene(this.pendingSceneInit),this.currentScene.loadScene(),console.log("Starting Scene Load"),this.resourceManager.loadResourcesFromQueue(()=>{console.log("Starting Scene"),this.currentScene.startScene(),this.currentScene.setRunning(!0)}),this.renderingManager.setScene(this.currentScene)}generateId(){return this.idCounter++}render(){this.currentScene&&this.currentScene.render()}update(e){this.pendingScene!==null&&this.doSceneChange(),this.currentScene&&this.currentScene.isRunning()&&this.currentScene.update(e)}}class ie extends Object{static initStats(){let e=document.getElementById("stats-canvas");e.width=this.CANVAS_WIDTH,e.height=this.CANVAS_HEIGHT,this.ctx=e.getContext("2d"),this.statsDiv=document.getElementById("stats-display"),this.prevfps=new Array,this.prevClearTimes=new Array,this.SGClearTimes=new Array,this.avgSGClearTime=0,this.prevFillTimes=new Array,this.SGFillTimes=new Array,this.avgSGFillTime=0,this.prevUpdateTimes=new Array,this.SGUpdateTimes=new Array,this.avgSGUpdateTime=0,this.prevQueryTimes=new Array,this.SGQueryTimes=new Array,this.avgSGQueryTime=0;let t=document.createElement("span");t.setAttribute("id","sgclear");let i=document.createElement("span");i.setAttribute("id","sgfill");let s=document.createElement("span");s.setAttribute("id","sgupdate");let a=document.createElement("span");a.setAttribute("id","sgquery");let o=document.createElement("br"),d=document.createElement("br"),h=document.createElement("br");this.statsDiv.append(t,o,i,d,s,h,a),this.graphChoices=document.getElementById("chart-option");let c=document.createElement("option");c.value="prevfps",c.label="FPS";let u=document.createElement("option");u.value="prevClearTimes",u.label="Clear Time";let y=document.createElement("option");y.value="prevFillTimes",y.label="Fill time";let m=document.createElement("option");m.value="prevUpdateTimes",m.label="Update time";let f=document.createElement("option");f.value="prevQueryTimes",f.label="Query Time";let A=document.createElement("option");A.value="all",A.label="All",this.graphChoices.append(c,u,y,m,f,A)}static updateFPS(e){this.prevfps.push(e),this.prevfps.length>ie.NUM_POINTS&&this.prevfps.shift(),this.SGClearTimes.length>0&&(this.prevClearTimes.push(this.avgSGClearTime),this.prevClearTimes.length>this.NUM_POINTS&&this.prevClearTimes.shift()),this.SGFillTimes.length>0&&(this.prevFillTimes.push(this.avgSGFillTime),this.prevFillTimes.length>this.NUM_POINTS&&this.prevFillTimes.shift()),this.SGUpdateTimes.length>0&&(this.prevUpdateTimes.push(this.avgSGUpdateTime),this.prevUpdateTimes.length>this.NUM_POINTS&&this.prevUpdateTimes.shift()),this.SGQueryTimes.length>0&&(this.prevQueryTimes.push(this.avgSGQueryTime),this.prevQueryTimes.length>this.NUM_POINTS&&this.prevQueryTimes.shift()),this.updateSGStats()}static log(e,t){e==="sgclear"?(this.SGClearTimes.push(t),this.SGClearTimes.length>100&&this.SGClearTimes.shift()):e==="sgfill"?(this.SGFillTimes.push(t),this.SGFillTimes.length>100&&this.SGFillTimes.shift()):e==="sgupdate"?(this.SGUpdateTimes.push(t),this.SGUpdateTimes.length>100&&this.SGUpdateTimes.shift()):e==="sgquery"&&(this.SGQueryTimes.push(t),this.SGQueryTimes.length>1e3&&this.SGQueryTimes.shift())}static render(){this.drawCharts()}static drawCharts(){this.ctx.clearRect(0,0,this.CANVAS_WIDTH,this.CANVAS_HEIGHT);let e=this.graphChoices.value;if(e==="prevfps"||e==="all"){let t=this.prevfps,i=g.BLUE.toString();this.drawChart(t,i)}if(e==="prevClearTimes"||e==="all"){let t=this.prevClearTimes,i=g.RED.toString();this.drawChart(t,i)}if(e==="prevFillTimes"||e==="all"){let t=this.prevFillTimes,i=g.GREEN.toString();this.drawChart(t,i)}if(e==="prevUpdateTimes"||e==="all"){let t=this.prevUpdateTimes,i=g.CYAN.toString();this.drawChart(t,i)}if(e==="prevQueryTimes"||e==="all"){let t=this.prevQueryTimes,i=g.ORANGE.toString();this.drawChart(t,i)}}static drawChart(e,t){this.ctx.strokeStyle=g.BLACK.toString(),this.ctx.beginPath(),this.ctx.moveTo(10,10),this.ctx.lineTo(10,this.CANVAS_HEIGHT-10),this.ctx.closePath(),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.moveTo(10,this.CANVAS_HEIGHT-10),this.ctx.lineTo(this.CANVAS_WIDTH-10,this.CANVAS_HEIGHT-10),this.ctx.closePath(),this.ctx.stroke();let i=Math.max(...e),s=10,a=this.CANVAS_HEIGHT-10-e[0]/i*(this.CANVAS_HEIGHT-20);this.ctx.strokeStyle=t;for(let o=1;o<e.length;o++){let d=e[o],h=10+o*(this.CANVAS_WIDTH-20)/this.NUM_POINTS,c=this.CANVAS_HEIGHT-10-d/i*(this.CANVAS_HEIGHT-20);this.ctx.beginPath(),this.ctx.moveTo(s,a),this.ctx.lineTo(h,c),this.ctx.closePath(),this.ctx.stroke(),s=h,a=c}}static updateSGStats(){this.SGClearTimes.length>0&&(this.avgSGClearTime=this.SGClearTimes.reduce((e,t)=>e+t)/this.SGClearTimes.length),this.SGFillTimes.length>0&&(this.avgSGFillTime=this.SGFillTimes.reduce((e,t)=>e+t)/this.SGFillTimes.length),this.SGUpdateTimes.length>0&&(this.avgSGUpdateTime=this.SGUpdateTimes.reduce((e,t)=>e+t)/this.SGUpdateTimes.length),this.SGQueryTimes.length>0&&(this.avgSGQueryTime=this.SGQueryTimes.reduce((e,t)=>e+t)/this.SGQueryTimes.length),document.getElementById("sgclear").innerHTML="Avg SG clear time: "+this.avgSGClearTime,document.getElementById("sgfill").innerHTML="Avg SG fill time: "+this.avgSGFillTime,document.getElementById("sgupdate").innerHTML="Avg SG update time: "+this.avgSGUpdateTime,document.getElementById("sgquery").innerHTML="Avg SG query time: "+this.avgSGQueryTime}}ie.NUM_POINTS=60;ie.CANVAS_WIDTH=300;ie.CANVAS_HEIGHT=300;class pe{constructor(){this.eventQueue=te.getInstance()}fireEvent(e,t=null){this.eventQueue.addEvent(new re(e,t))}}function ei(n){return n&&n.size&&n.scale&&n.boundary}var k;(function(n){n[n.STOPPED=0]="STOPPED",n[n.PAUSED=1]="PAUSED",n[n.PLAYING=2]="PLAYING"})(k||(k={}));class ti{static easeInOutSine(e){return-(Math.cos(Math.PI*e)-1)/2}static easeOutInSine(e){return e<.5?-Math.cos(Math.PI*(e+.5))/2:-Math.cos(Math.PI*(e-.5))/2+1}static easeOutSine(e){return Math.sin(e*Math.PI/2)}static easeInSine(e){return 1-Math.cos(e*Math.PI/2)}static easeInOutQuint(e){return e<.5?16*e*e*e*e*e:1-Math.pow(-2*e+2,5)/2}static easeInOutQuad(e){return e<.5?2*e*e:1-Math.pow(-2*e+2,2)/2}static easeOutInQuad(e){return e<.5?this.easeOutIn_OutPow(e,2):this.easeOutIn_InPow(e,2)}static easeOutIn_OutPow(e,t){return .5-Math.pow(-2*e+1,t)/2}static easeOutIn_InPow(e,t){return .5+Math.pow(2*e-1,t)/2}}var xt;(function(n){n.IN_OUT_SINE="easeInOutSine",n.OUT_IN_SINE="easeOutInSine",n.IN_SINE="easeInSine",n.OUT_SINE="easeOutSine",n.IN_OUT_QUAD="easeInOutQuad",n.OUT_IN_QUAD="easeOutInQuad",n.IN_OUT_QUINT="easeInOutQuint"})(xt||(xt={}));class he{constructor(){this.tweenControllers=new Array}static getInstance(){return he.instance===null&&(he.instance=new he),he.instance}registerTweenController(e){this.tweenControllers.push(e)}deregisterTweenController(e){let t=this.tweenControllers.indexOf(e);this.tweenControllers.splice(t,1)}clearTweenControllers(){this.tweenControllers=new Array}update(e){for(let t of this.tweenControllers)t.update(e)}}he.instance=null;class ii{constructor(e){this.owner=e,this.tweens=new L,this.emitter=new pe,he.getInstance().registerTweenController(this)}destroy(){delete this.owner.tweens,he.getInstance().deregisterTweenController(this)}add(e,t){let i=t;i.progress=0,i.elapsedTime=0,i.animationState=k.STOPPED,this.tweens.add(e,i)}play(e,t){if(this.tweens.has(e)){let i=this.tweens.get(e);t!==void 0&&(i.loop=t);for(let s of i.effects)s.resetOnComplete&&(s.initialValue=this.owner[s.property]);i.animationState=k.PLAYING,i.elapsedTime=0,i.progress=0,i.reversing=!1}else console.warn(`Tried to play tween "${e}" on node with id ${this.owner.id}, but no such tween exists`)}pause(e){this.tweens.has(e)&&(this.tweens.get(e).animationState=k.PAUSED)}resume(e){if(this.tweens.has(e)){let t=this.tweens.get(e);t.animationState===k.PAUSED&&(t.animationState=k.PLAYING)}}stop(e){if(this.tweens.has(e)){let t=this.tweens.get(e);t.animationState=k.STOPPED;for(let i of t.effects)i.resetOnComplete&&(this.owner[i.property]=i.initialValue)}}end(e){if(this.stop(e),this.tweens.has(e)){let t=this.tweens.get(e);t.onEnd&&this.emitter.fireEvent(t.onEnd,{key:e,node:this.owner.id})}}stopAll(){this.tweens.forEach(e=>this.stop(e))}update(e){this.tweens.forEach(t=>{let i=this.tweens.get(t);if(i.animationState===k.PLAYING&&(i.elapsedTime+=e*1e3,i.elapsedTime>=i.startDelay)){!i.reversing&&i.elapsedTime>=i.startDelay+i.duration&&(i.reverseOnComplete?i.reversing=!0:i.loop?i.elapsedTime-=i.duration:this.end(t)),i.reversing&&i.elapsedTime>=i.startDelay+2*i.duration&&(i.loop?(i.reversing=!1,i.elapsedTime-=2*i.duration):this.end(t)),i.reversing?i.progress=w.clamp01((2*i.duration-(i.elapsedTime-i.startDelay))/i.duration):i.progress=w.clamp01((i.elapsedTime-i.startDelay)/i.duration);for(let s of i.effects){let a=ti[s.ease](i.progress),o=w.lerp(s.start,s.end,a);this.owner[s.property]=o}}})}}class si{constructor(){this.hasPhysics=!1,this.moving=!1,this.frozen=!1,this.onGround=!1,this.onWall=!1,this.onCeiling=!1,this.active=!1,this.isColliding=!1,this.pathfinding=!1,this._position=new r(0,0),this._position.setOnChange(()=>this.positionChanged()),this.receiver=new ye,this.emitter=new pe,this.tweens=new ii(this),this.rotation=0}destroy(){this.tweens.destroy(),this.receiver.destroy(),this.hasPhysics&&this.removePhysics(),this._ai&&(this._ai.destroy(),delete this._ai,this.scene.getAIManager().removeActor(this)),this.scene.remove(this),this.layer.removeNode(this)}get position(){return this._position}set position(e){this._position=e,this._position.setOnChange(()=>this.positionChanged()),this.positionChanged()}get relativePosition(){return this.inRelativeCoordinates(this.position)}inRelativeCoordinates(e){let t=this.scene.getViewTranslation(this),i=this.scene.getViewScale();return e.clone().sub(t).scale(i)}get id(){return this._id}set id(e){if(this._id===void 0)this._id=e;else throw"Attempted to assign id to object that already has id."}move(e){this.frozen||(this.moving=!0,this._velocity=e)}moveOnPath(e,t){if(this.frozen)return;this.path=t;let i=t.getMoveDirection(this);this.moving=!0,this.pathfinding=!0,this._velocity=i.scale(e)}finishMove(){this.moving=!1,this.position.add(this._velocity),this.pathfinding&&(this.path.handlePathProgress(this),this.path=null,this.pathfinding=!1)}addPhysics(e,t,i=!0,s=!1){if(this.hasPhysics=!0,this.moving=!1,this.onGround=!1,this.onWall=!1,this.onCeiling=!1,this.active=!0,this.isCollidable=i,this.isStatic=s,this.isTrigger=!1,this.triggerMask=0,this.triggerEnters=new Array(32),this.triggerExits=new Array(32),this._velocity=r.ZERO,this.sweptRect=new z,this.collidedWithTilemap=!1,this.group=-1,e)this.collisionShape=e,this.collisionShape.center=this.position;else if(ei(this))this.collisionShape=this.boundary.clone();else throw"No collision shape specified for physics object.";t?this.colliderOffset=t:this.colliderOffset=r.ZERO,this.sweptRect=this.collisionShape.getBoundingRect(),this.scene.getPhysicsManager().registerObject(this)}removePhysics(){this.scene.getPhysicsManager().deregisterObject(this),this.hasPhysics=!1,this.moving=!1,this.onGround=!1,this.onWall=!1,this.onCeiling=!1,this.active=!1,this.isCollidable=!1,this.isStatic=!1,this.isTrigger=!1,this.triggerMask=0,this.triggerEnters=null,this.triggerExits=null,this._velocity=r.ZERO,this.sweptRect=null,this.collidedWithTilemap=!1,this.group=-1,this.collisionShape=null,this.colliderOffset=r.ZERO,this.sweptRect=null}freeze(){this.frozen=!0}unfreeze(){this.frozen=!1}disablePhysics(){this.active=!1}enablePhysics(){this.active=!0}setCollisionShape(e){this.collisionShape=e,this.collisionShape.center.copy(this.position)}setTrigger(e,t,i){this.isTrigger=!0;let s=this.scene.getPhysicsManager().getGroupNumber(e);if(s===0){console.warn(`Trigger for GameNode ${this.id} not set - group "${e}" was not recognized by the physics manager.`);return}this.triggerMask|=s;let a=Math.log2(s);this.triggerEnters[a]=t,this.triggerExits[a]=i}setGroup(e){this.scene.getPhysicsManager().setGroup(this,e)}getLastVelocity(){return this._velocity}get ai(){return this._ai}set ai(e){this._ai||this.scene.getAIManager().registerActor(this),this._ai=e,this.aiActive=!0}addAI(e,t,i){this._ai||this.scene.getAIManager().registerActor(this),typeof e=="string"?this._ai=this.scene.getAIManager().generateAI(e):this._ai=new e,this._ai.initializeAI(this,t),this.aiActive=!0}setAIActive(e,t){this.aiActive=e,this.aiActive&&this.ai.activate(t)}set positionX(e){this.position.x=e}set positionY(e){this.position.y=e}setScene(e){this.scene=e}getScene(){return this.scene}setLayer(e){this.layer=e}getLayer(){return this.layer}positionChanged(){this.collisionShape&&(this.colliderOffset?this.collisionShape.center=this.position.clone().add(this.colliderOffset):this.collisionShape.center=this.position.clone())}update(e){for(;this.receiver.hasNextEvent();)this._ai.handleEvent(this.receiver.getNextEvent())}debugRender(){if(F.drawPoint(this.relativePosition,g.BLUE),this._velocity&&!this._velocity.isZero()&&F.drawRay(this.relativePosition,this._velocity.clone().scaleTo(20).add(this.relativePosition),g.BLUE),this.collisionShape){let e=this.isColliding?g.RED:g.GREEN;this.isTrigger&&(e=g.MAGENTA),e.a=.2,this.collisionShape instanceof z?F.drawBox(this.inRelativeCoordinates(this.collisionShape.center),this.collisionShape.halfSize.scaled(this.scene.getViewScale()),!0,e):this.collisionShape instanceof Ye&&F.drawCircle(this.inRelativeCoordinates(this.collisionShape.center),this.collisionShape.hw*this.scene.getViewScale(),!0,e)}}}var vt;(function(n){n.posX="positionX",n.posY="positionY",n.scaleX="scaleX",n.scaleY="scaleY",n.rotation="rotation",n.alpha="alpha"})(vt||(vt={}));class Te extends si{constructor(){super(),this.visible=!0,this._size=new r(0,0),this._size.setOnChange(()=>this.sizeChanged()),this._scale=new r(1,1),this._scale.setOnChange(()=>this.scaleChanged()),this._boundary=new z,this.updateBoundary(),this._hasCustomShader=!1}get alpha(){return this._alpha}set alpha(e){this._alpha=e}get size(){return this._size}set size(e){this._size=e,this._size.setOnChange(()=>this.sizeChanged()),this.sizeChanged()}get scale(){return this._scale}set scale(e){this._scale=e,this._scale.setOnChange(()=>this.scaleChanged()),this.scaleChanged()}set scaleX(e){this.scale.x=e}set scaleY(e){this.scale.y=e}get hasCustomShader(){return this._hasCustomShader}get customShaderKey(){return this._customShaderKey}positionChanged(){super.positionChanged(),this.updateBoundary()}sizeChanged(){this.updateBoundary()}scaleChanged(){this.updateBoundary()}updateBoundary(){this._boundary.center.set(this.position.x,this.position.y),this._boundary.halfSize.set(this.size.x*this.scale.x/2,this.size.y*this.scale.y/2)}get boundary(){return this._boundary}get sizeWithZoom(){let e=this.scene.getViewScale();return this.boundary.halfSize.clone().scaled(e,e)}useCustomShader(e){this._hasCustomShader=!0,this._customShaderKey=e}contains(e,t){return this._boundary.containsPoint(new r(e,t))}debugRender(){F.drawBox(this.relativePosition,this.sizeWithZoom,!1,g.BLUE),super.debugRender()}}class ke extends Te{constructor(){super(),this.color=g.RED}get alpha(){return this.color.a}set alpha(e){this.color.a=e}setColor(e){this.color=e}set colorR(e){this.color.r=e}get colorR(){return this.color.r}set colorG(e){this.color.g=e}get colorG(){return this.color.g}set colorB(e){this.color.b=e}get colorB(){return this.color.b}}class je extends ke{constructor(e){super(),this.position=e,this.size.set(5,5)}}class Be extends ke{constructor(e,t){super(),this.position=e,this.size=t,this.borderColor=g.TRANSPARENT,this.borderWidth=0}setBorderColor(e){this.borderColor=e}getBorderColor(){return this.borderColor}setBorderWidth(e){this.borderWidth=e}getBorderWidth(){return this.borderWidth}}class Re extends Te{constructor(e){super(),this.imageId=e;let t=D.getInstance().getImage(this.imageId);this.size=new r(t.width,t.height),this.imageOffset=r.ZERO,this.invertX=!1,this.invertY=!1}setImageOffset(e){this.imageOffset=e}}class ni extends Te{constructor(e,t,i,s){super(),this.tilesets=i,this.tileSize=new r(0,0),this.name=t.name;let a=0;for(let o of i)a+=o.getTileCount()+1;this.collisionMap=new Array(a);for(let o=0;o<this.collisionMap.length;o++)this.collisionMap[o]=!1;this.parseTilemapData(e,t),this.scale.set(s.x,s.y)}getTilesets(){return this.tilesets}getTileSize(){return this.tileSize.scaled(this.scale.x,this.scale.y)}getTileSizeWithZoom(){let e=this.scene.getViewScale();return this.getTileSize().scale(e)}addPhysics(){this.hasPhysics=!0,this.active=!0,this.group=-1,this.scene.getPhysicsManager().registerTilemap(this)}}class Ge extends ni{parseTilemapData(e,t){if(this.numCols=e.width,this.numRows=e.height,this.tileSize.set(e.tilewidth,e.tileheight),this.size.set(this.numCols*this.tileSize.x,this.numRows*this.tileSize.y),this.position.copy(this.size.scaled(.5)),this.data=t.data,this.visible=t.visible,this.isCollidable=!1,t.properties){for(let i of t.properties)if(i.name==="Collidable"){this.isCollidable=i.value;for(let s=1;s<this.collisionMap.length;s++)this.collisionMap[s]=!0}}}getDimensions(){return new r(this.numCols,this.numRows)}getTileAtWorldPosition(e){let t=this.getColRowAt(e);return this.getTileAtRowCol(t)}getTileAtRowCol(e){return e.x<0||e.x>=this.numCols||e.y<0||e.y>=this.numRows?-1:this.data[e.y*this.numCols+e.x]}getTileWorldPosition(e){let t=e%this.numCols,i=Math.floor(e/this.numCols),s=t*this.tileSize.x,a=i*this.tileSize.y;return new r(s,a)}getTile(e){return this.data[e]}setTile(e,t){this.data[e]=t}setTileAtRowCol(e,t){let i=e.y*this.numCols+e.x;this.setTile(i,t)}isTileCollidable(e,t){let i=0;if(t){if(i=this.getTileAtRowCol(new r(e,t)),i<0)return!1}else{if(e<0||e>=this.data.length)return!1;i=this.getTile(e)}return this.collisionMap[i]}getColRowAt(e){let t=Math.floor(e.x/this.tileSize.x/this.scale.x),i=Math.floor(e.y/this.tileSize.y/this.scale.y);return new r(t,i)}update(e){}debugRender(){let e=this.getTileSizeWithZoom().scaled(.5),t=this.getTileSize().scaled(.5),i=this.position.clone().sub(this.size.scaled(.5)),s=r.ZERO;for(let a=0;a<this.numCols;a++){s.x=i.x+a*2*t.x+t.x;for(let o=0;o<this.numRows;o++)this.isCollidable&&this.isTileCollidable(a,o)&&(s.y=i.y+o*2*t.y+t.y,F.drawBox(this.inRelativeCoordinates(s),e,!1,g.BLUE))}}}class Ve extends Te{constructor(e){super(),this.position=e,this.backgroundColor=new g(0,0,0,0),this.borderColor=new g(0,0,0,0),this.borderRadius=5,this.borderWidth=1,this.padding=r.ZERO,this.onClick=null,this.onClickEventId=null,this.onRelease=null,this.onReleaseEventId=null,this.onEnter=null,this.onEnterEventId=null,this.onLeave=null,this.onLeaveEventId=null,this.isClicked=!1,this.isEntered=!1}setBackgroundColor(e){this.backgroundColor=e}setPadding(e){this.padding.copy(e)}update(e){if(super.update(e),l.isMouseJustPressed()){let i=l.getMousePosition();if(this.contains(i.x,i.y)&&this.visible&&!this.layer.isHidden()&&(this.isClicked=!0,this.onClick!==null&&this.onClick(),this.onClickEventId!==null)){let s={};this.emitter.fireEvent(this.onClickEventId,s)}}l.isMousePressed()||this.isClicked&&(this.isClicked=!1);let t=l.getMousePosition();if(t&&this.contains(t.x,t.y)){if(this.isEntered=!0,this.onEnter!==null&&this.onEnter(),this.onEnterEventId!==null){let i={};this.emitter.fireEvent(this.onEnterEventId,i)}}else if(this.isEntered){if(this.isEntered=!1,this.onLeave!==null&&this.onLeave(),this.onLeaveEventId!==null){let i={};this.emitter.fireEvent(this.onLeaveEventId,i)}}else this.isClicked&&(this.isClicked=!1)}calculateBackgroundColor(){return this.backgroundColor}calculateBorderColor(){return this.borderColor}}class ai{constructor(e){this.resourceManager=D.getInstance(),this.ctx=e}setScene(e){this.scene=e}renderPoint(e,t){this.ctx.fillStyle=e.color.toStringRGBA(),this.ctx.fillRect(-e.size.x/2*t,-e.size.y/2*t,e.size.x*t,e.size.y*t)}renderLine(e,t,i){this.ctx.strokeStyle=e.color.toStringRGBA(),this.ctx.lineWidth=e.thickness,this.ctx.beginPath(),this.ctx.moveTo(0,0),this.ctx.lineTo((e.end.x-e.start.x)*i,(e.end.y-e.start.y)*i),this.ctx.closePath(),this.ctx.stroke()}renderRect(e,t){e.color.a!==0&&(this.ctx.fillStyle=e.color.toStringRGB(),this.ctx.fillRect(-e.size.x/2*t,-e.size.y/2*t,e.size.x*t,e.size.y*t)),e.borderColor.a!==0&&(this.ctx.strokeStyle=e.getBorderColor().toStringRGB(),this.ctx.lineWidth=e.getBorderWidth(),this.ctx.strokeRect(-e.size.x/2*t,-e.size.y/2*t,e.size.x*t,e.size.y*t))}}class Mt{constructor(){this.resourceManager=D.getInstance()}setScene(e){this.scene=e}}class ri{constructor(e){this.resourceManager=D.getInstance(),this.ctx=e}setScene(e){this.scene=e}renderOrthogonalTilemap(e){let t=this.ctx.globalAlpha;this.ctx.globalAlpha=e.getLayer().getAlpha();let i=this.scene.getViewTranslation(e),s=this.scene.getViewport().getHalfSize(),a=this.scene.getViewScale(),o=i.clone().add(s.scaled(2*a));if(e.visible){let d=e.getColRowAt(i),h=e.getColRowAt(o);for(let c=d.x;c<=h.x;c++)for(let u=d.y;u<=h.y;u++){let y=e.getTileAtRowCol(new r(c,u));const m=14<<28,f=(m&y)>>28&15;y=y&~m;for(let A of e.getTilesets())A.hasTile(y)&&this.renderTile(A,y,c,u,i,e.scale,a,f)}}this.ctx.globalAlpha=t}renderTile(e,t,i,s,a,o,d,h){let c=this.resourceManager.getImage(e.getImageKey()),u=t-e.getStartIndex(),y=Math.floor(u/e.getNumCols()),m=u%e.getNumCols(),f=e.getTileSize().x,A=e.getTileSize().y,T=m*f,S=y*A,W=Math.floor(i*f*o.x),K=Math.floor(s*A*o.y),se=Math.floor((W-a.x)*d),ne=Math.floor((K-a.y)*d),Y=Math.ceil(f*o.x*d),V=Math.ceil(A*o.y*d);if(h!==0){let R=1,b=1,Se=0,ze=0;h&8&&(R=-1),h&4&&(b=-1),h&2&&(Se=b,ze=R,R=0,b=0),this.ctx.setTransform(R,Se,ze,b,se+Y/2,ne+V/2),this.ctx.drawImage(c,T,S,f,A,-Y/2,-V/2,Y,V),h!==0&&this.ctx.setTransform(1,0,0,1,0,0)}else this.ctx.drawImage(c,T,S,f,A,se,ne,Y,V)}}class oi{constructor(e){this.resourceManager=D.getInstance(),this.ctx=e}setScene(e){this.scene=e}renderLabel(e){e.handleInitialSizing(this.ctx);let t=this.ctx.globalAlpha;this.ctx.font=e.getFontString();let i=e.calculateTextOffset(this.ctx);this.ctx.globalAlpha=e.backgroundColor.a,this.ctx.fillStyle=e.calculateBackgroundColor().toStringRGBA(),this.ctx.fillRoundedRect(-e.size.x/2,-e.size.y/2,e.size.x,e.size.y,e.borderRadius),this.ctx.strokeStyle=e.calculateBorderColor().toStringRGBA(),this.ctx.globalAlpha=e.borderColor.a,this.ctx.lineWidth=e.borderWidth,this.ctx.strokeRoundedRect(-e.size.x/2,-e.size.y/2,e.size.x,e.size.y,e.borderRadius),this.ctx.fillStyle=e.calculateTextColor(),this.ctx.globalAlpha=e.textColor.a,this.ctx.fillText(e.text,i.x-e.size.x/2,i.y-e.size.y/2),this.ctx.globalAlpha=t}renderButton(e){this.renderLabel(e)}renderSlider(e){let t=this.ctx.globalAlpha;this.ctx.globalAlpha=e.getLayer().getAlpha();let i=new r(e.size.x,2);this.ctx.fillStyle=e.sliderColor.toString(),this.ctx.fillRoundedRect(-i.x/2,-i.y/2,i.x,i.y,e.borderRadius);let s=w.lerp(-e.size.x/2,e.size.x/2,e.getValue());this.ctx.fillStyle=e.nibColor.toString(),this.ctx.fillRoundedRect(s-e.nibSize.x/2,-e.nibSize.y/2,e.nibSize.x,e.nibSize.y,e.borderRadius),this.ctx.globalAlpha=t}renderTextInput(e){e.focused&&e.cursorCounter%60>30&&(e.text+="|"),this.renderLabel(e),e.focused&&(e.cursorCounter%60>30&&(e.text=e.text.substring(0,e.text.length-1)),e.cursorCounter+=1,e.cursorCounter>=60&&(e.cursorCounter=0))}}class _e extends Ve{constructor(e,t){super(e),this.text=t,this.textColor=new g(0,0,0,1),this.font="Arial",this.fontSize=30,this.hAlign="center",this.vAlign="center",this.sizeAssigned=!1}setText(e){this.text=e}setTextColor(e){this.textColor=e}getFontString(){return this.fontSize+"px "+this.font}calculateTextColor(){return this.textColor.toStringRGBA()}calculateTextWidth(e){return e.font=this.fontSize+"px "+this.font,e.measureText(this.text).width}setHAlign(e){this.hAlign=e}setVAlign(e){this.vAlign=e}calculateTextOffset(e){let t=this.calculateTextWidth(e),i=new r(0,0),s=this.size.x-t;return this.hAlign===$.CENTER?i.x=s/2:this.hAlign===$.RIGHT?i.x=s-this.padding.x:i.x=this.padding.x,this.vAlign===Fe.TOP?(e.textBaseline="top",i.y=0):this.vAlign===Fe.BOTTOM?(e.textBaseline="bottom",i.y=this.size.y):(e.textBaseline="middle",i.y=this.size.y/2),i}sizeChanged(){super.sizeChanged(),this.sizeAssigned=!0}autoSize(e){let t=this.calculateTextWidth(e),i=this.fontSize;this.size.set(t+this.padding.x*2,i+this.padding.y*2),this.sizeAssigned=!0}handleInitialSizing(e){this.sizeAssigned||this.autoSize(e)}sizeToText(){this.sizeAssigned=!1}}var Fe;(function(n){n.TOP="top",n.CENTER="center",n.BOTTOM="bottom"})(Fe||(Fe={}));var $;(function(n){n.LEFT="left",n.CENTER="center",n.RIGHT="right"})($||($={}));class It extends _e{constructor(e,t){super(e,t),this.backgroundColor=new g(150,75,203),this.borderColor=new g(41,46,30),this.textColor=new g(255,255,255)}calculateBackgroundColor(){return this.isEntered&&!this.isClicked?this.backgroundColor.lighten():this.isClicked?this.backgroundColor.darken():this.backgroundColor}}class Rt extends Ve{constructor(e,t){super(e),this.value=t,this.nibColor=g.RED,this.sliderColor=g.BLACK,this.backgroundColor=g.TRANSPARENT,this.borderColor=g.TRANSPARENT,this.nibSize=new r(10,20),this.size.set(200,20)}getValue(){return this.value}valueChanged(){this.onValueChange&&this.onValueChange(this.value),this.onValueChangeEventId&&this.emitter.fireEvent(this.onValueChangeEventId,{target:this,value:this.value})}update(e){if(super.update(e),this.isClicked){let t=w.invLerp(this.position.x-this.size.x/2,this.position.x+this.size.x/2,l.getMousePosition().x);this.value=w.clamp01(t),this.valueChanged()}}}class Dt extends _e{constructor(e){super(e,""),this.focused=!1,this.cursorCounter=0,this.size.set(200,this.fontSize),this.hAlign="left",this.borderColor=g.BLACK,this.backgroundColor=g.WHITE}update(e){if(super.update(e),l.isMouseJustPressed()){let t=l.getMousePressPosition();this.contains(t.x,t.y)?(this.focused=!0,this.cursorCounter=30):this.focused=!1}if(this.focused){let t=l.getKeysJustPressed(),o="1234567890"+"`~!@#$%^&*()-_=+[{]}\\|;:'\",<.>/?"+"qwertyuiopasdfghjklzxcvbnm";t=t.filter(u=>o.includes(u));let d=l.isKeyPressed("shift"),h=l.isKeyJustPressed("backspace"),c=l.isKeyJustPressed("space");h?this.text=this.text.substring(0,this.text.length-1):c?this.text+=" ":t.length>0&&(d?this.text+=t[0].toUpperCase():this.text+=t[0])}}}class hi{constructor(e){this.owner=e,this.animationState=k.STOPPED,this.currentAnimation="",this.currentFrame=0,this.frameProgress=0,this.loop=!1,this.animations=new L,this.onEndEvent=null,this.emitter=new pe}add(e,t){this.animations.add(e,t)}getIndex(){return this.animations.has(this.currentAnimation)?this.animations.get(this.currentAnimation).frames[this.currentFrame].index:(console.warn(`Animation index was requested, but the current animation: ${this.currentAnimation} was invalid`),0)}getAnimationData(){if(this.animations.has(this.currentAnimation))return this.animations.get(this.currentAnimation).frames[this.currentFrame]}isPlaying(e){return this.currentAnimation===e&&this.animationState===k.PLAYING}getIndexAndAdvanceAnimation(){if(this.animationState!==k.PLAYING)return this.getIndex();if(this.animations.has(this.currentAnimation)){let e=this.animations.get(this.currentAnimation),t=e.frames[this.currentFrame].index;return this.frameProgress+=1,this.frameProgress>=e.frames[this.currentFrame].duration&&(this.frameProgress=0,this.currentFrame+=1,this.currentFrame>=e.frames.length&&(this.loop?(this.currentFrame=0,this.frameProgress=0):this.endCurrentAnimation())),t}else return console.warn(`Animation index and advance was requested, but the current animation (${this.currentAnimation}) in node with id: ${this.owner.id} was invalid`),0}endCurrentAnimation(){this.currentFrame=0,this.animationState=k.STOPPED,this.onEndEvent!==null&&this.emitter.fireEvent(this.onEndEvent,{owner:this.owner.id,animation:this.currentAnimation}),this.pendingAnimation!==null&&this.play(this.pendingAnimation,this.pendingLoop,this.pendingOnEnd)}playIfNotAlready(e,t,i){this.currentAnimation!==e&&this.play(e,t,i)}play(e,t,i){this.currentAnimation=e,this.currentFrame=0,this.frameProgress=0,this.animationState=k.PLAYING,t!==void 0?this.loop=t:this.loop=this.animations.get(e).repeat,i!==void 0?this.onEndEvent=i:this.onEndEvent=null,this.pendingAnimation=null}queue(e,t=!1,i){this.pendingAnimation=e,this.pendingLoop=t,i!==void 0?this.pendingOnEnd=i:this.pendingOnEnd=null}pause(){this.animationState=k.PAUSED}resume(){this.animationState===k.PAUSED&&(this.animationState=k.PLAYING)}stop(){this.animationState=k.STOPPED}}class Qe extends Re{get cols(){return this.numCols}get rows(){return this.numRows}constructor(e){super(e.name),this.numCols=e.columns,this.numRows=e.rows,this.size.set(e.spriteWidth,e.spriteHeight),this.animation=new hi(this);for(let t of e.animations)this.animation.add(t.name,t)}getAnimationOffset(e){const t=this.animation.getAnimationData();return new r(t.x,t.y)}}class kt extends ke{constructor(e,t){super(),this.start=e,this.end=t,this.thickness=2,this.size.set(5,5)}set start(e){this.position=e}get start(){return this.position}set end(e){this._end=e}get end(){return this._end}}class li extends Mt{constructor(){super()}setScene(e){this.scene=e,this.graphicRenderer.setScene(e),this.tilemapRenderer.setScene(e),this.uiElementRenderer.setScene(e)}initializeCanvas(e,t,i){return e.width=t,e.height=i,this.worldSize=new r(t,i),this.ctx=e.getContext("2d"),this.graphicRenderer=new ai(this.ctx),this.tilemapRenderer=new ri(this.ctx),this.uiElementRenderer=new oi(this.ctx),this.ctx.imageSmoothingEnabled=!1,this.ctx}render(e,t,i){e.sort((c,u)=>c.getLayer().getDepth()===u.getLayer().getDepth()?c.boundary.bottom-u.boundary.bottom:c.getLayer().getDepth()-u.getLayer().getDepth());let s=0,a=t.length,o=0,d=e.length;for(;s<a||o<d;){if(s>=a){let c=e[o++];c.visible&&this.renderNode(c);continue}if(o>=d){this.renderTilemap(t[s++]);continue}if(t[s].getLayer().getDepth()<=e[o].getLayer().getDepth())this.renderTilemap(t[s++]);else{let c=e[o++];c.visible&&this.renderNode(c)}}let h=new Array;i.forEach(c=>h.push(i.get(c))),h=h.sort((c,u)=>c.getDepth()-u.getDepth()),h.forEach(c=>{c.isHidden()||c.getItems().forEach(u=>{u.visible&&this.renderNode(u)})})}renderNode(e){this.origin=this.scene.getViewTranslation(e),this.zoom=this.scene.getViewScale();let t=1,i=1;e instanceof Re&&(t=e.invertX?-1:1,i=e.invertY?-1:1),this.ctx.setTransform(t,0,0,i,(e.position.x-this.origin.x)*this.zoom,(e.position.y-this.origin.y)*this.zoom),this.ctx.rotate(-e.rotation);let s=this.ctx.globalAlpha;e instanceof Be&&F.log("node"+e.id,"Node"+e.id+" Alpha: "+e.alpha),this.ctx.globalAlpha=e.alpha,e instanceof Qe?this.renderAnimatedSprite(e):e instanceof Re?this.renderSprite(e):e instanceof ke?this.renderGraphic(e):e instanceof Ve&&this.renderUIElement(e),this.ctx.globalAlpha=s,this.ctx.setTransform(1,0,0,1,0,0)}renderSprite(e){let t=this.resourceManager.getImage(e.imageId);this.ctx.drawImage(t,e.imageOffset.x,e.imageOffset.y,e.size.x,e.size.y,-e.size.x*e.scale.x/2*this.zoom,-e.size.y*e.scale.y/2*this.zoom,e.size.x*e.scale.x*this.zoom,e.size.y*e.scale.y*this.zoom)}renderAnimatedSprite(e){let t=this.resourceManager.getImage(e.imageId),i=e.animation.getIndexAndAdvanceAnimation(),s=e.getAnimationOffset(i);this.ctx.drawImage(t,e.imageOffset.x+s.x,e.imageOffset.y+s.y,e.size.x,e.size.y,-e.size.x*e.scale.x/2*this.zoom,-e.size.y*e.scale.y/2*this.zoom,e.size.x*e.scale.x*this.zoom,e.size.y*e.scale.y*this.zoom)}renderGraphic(e){e instanceof je?this.graphicRenderer.renderPoint(e,this.zoom):e instanceof kt?this.graphicRenderer.renderLine(e,this.origin,this.zoom):e instanceof Be&&this.graphicRenderer.renderRect(e,this.zoom)}renderTilemap(e){e instanceof Ge&&this.tilemapRenderer.renderOrthogonalTilemap(e)}renderUIElement(e){e instanceof _e?this.uiElementRenderer.renderLabel(e):e instanceof It?this.uiElementRenderer.renderButton(e):e instanceof Rt?this.uiElementRenderer.renderSlider(e):e instanceof Dt&&this.uiElementRenderer.renderTextInput(e)}clear(e){this.ctx.clearRect(0,0,this.worldSize.x,this.worldSize.y),this.ctx.fillStyle=e.toString(),this.ctx.fillRect(0,0,this.worldSize.x,this.worldSize.y)}}class ot{static parse(e){let t=new ot;return t.canvasSize=e.canvasSize?e.canvasSize:{x:800,y:600},t.zoomLevel=e.zoomLevel?e.zoomLevel:1,t.clearColor=e.clearColor?e.clearColor:{r:255,g:255,b:255},t.inputs=e.inputs?e.inputs:[],t.showDebug=!!e.showDebug,t.showStats=!!e.showStats,t.useWebGL=!!e.useWebGL,t}}const Et=()=>{};class di{constructor(){this._doUpdate=Et,this._doRender=Et}set doUpdate(e){this._doUpdate=e}set doRender(e){this._doRender=e}}class ci extends di{constructor(){super(),this.doFrame=e=>{if(this.paused||(window.requestAnimationFrame(i=>this.doFrame(i)),e<this.lastFrameTime+this.minFrameDelay))return;this.startFrame(e),this.numUpdateSteps=0;let t=!1;for(;this.frameDelta>=this.updateTimestep;)if(this._doUpdate(this.updateTimestep/1e3),this.frameDelta-=this.updateTimestep,this.numUpdateSteps++,this.numUpdateSteps>100){t=!0;break}this._doRender(),this.finishFrame(t)},this.maxUpdateFPS=60,this.updateTimestep=Math.floor(1e3/this.maxUpdateFPS),this.frameDelta=0,this.lastFrameTime=0,this.minFrameDelay=0,this.frame=0,this.fps=this.maxUpdateFPS,this.fpsUpdateInterval=1e3,this.lastFpsUpdate=0,this.framesSinceLastFpsUpdate=0,this.started=!1,this.paused=!1,this.running=!1,this.numUpdateSteps=0}getFPS(){return 0}updateFPS(e){this.fps=.9*this.framesSinceLastFpsUpdate*1e3/(e-this.lastFpsUpdate)+(1-.9)*this.fps,this.lastFpsUpdate=e,this.framesSinceLastFpsUpdate=0,F.log("fps","FPS: "+this.fps.toFixed(1)),ie.updateFPS(this.fps)}setMaxUpdateFPS(e){this.maxUpdateFPS=e,this.updateTimestep=Math.floor(1e3/this.maxUpdateFPS)}setMaxFPS(e){this.minFrameDelay=1e3/e}resetFrameDelta(){let e=this.frameDelta;return this.frameDelta=0,e}start(){this.started||(this.started=!0,window.requestAnimationFrame(e=>this.doFirstFrame(e)))}pause(){this.paused=!0}resume(){this.paused=!1}doFirstFrame(e){this.running=!0,this._doRender(),this.lastFrameTime=e,this.lastFpsUpdate=e,this.framesSinceLastFpsUpdate=0,window.requestAnimationFrame(t=>this.doFrame(t))}startFrame(e){this.frameDelta+=e-this.lastFrameTime,this.lastFrameTime=e,e>this.lastFpsUpdate+this.fpsUpdateInterval&&this.updateFPS(e),this.frame++,this.framesSinceLastFpsUpdate++}finishFrame(e){if(e){var t=Math.round(this.resetFrameDelta());console.warn("Main loop panicked, probably because the browser tab was put in the background. Discarding "+t+"ms")}}}class ui{static setup(){CanvasRenderingContext2D.prototype.roundedRect=function(e,t,i,s,a){a<0&&(a=0),a>Math.min(i,s)&&(a=Math.min(i,s)),this.beginPath(),this.moveTo(e+a,t),this.lineTo(e+i-a,t),this.arcTo(e+i,t,e+i,t+a,a),this.lineTo(e+i,t+s-a),this.arcTo(e+i,t+s,e+i-a,t+s,a),this.lineTo(e+a,t+s),this.arcTo(e,t+s,e,t+s-a,a),this.lineTo(e,t+a),this.arcTo(e,t,e+a,t,a),this.closePath()},CanvasRenderingContext2D.prototype.strokeRoundedRect=function(e,t,i,s,a){this.roundedRect(e,t,i,s,a),this.stroke()},CanvasRenderingContext2D.prototype.fillRoundedRect=function(e,t,i,s,a){this.roundedRect(e,t,i,s,a),this.fill()}}}class X{constructor(){this.mat=new Float32Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])}static get IDENTITY(){return new X().identity()}static get ZERO(){return new X().zero()}set _00(e){this.mat[0]=e}set(e,t,i){if(e<0||e>3||t<0||t>3)throw`Error - index (${e}, ${t}) is out of bounds for Mat4x4`;return this.mat[t*4+e]=i,this}get(e,t){return this.mat[t*4+e]}setAll(...e){return this.mat.set(e),this}identity(){return this.setAll(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)}zero(){return this.setAll(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0)}rotate(e){return this.setAll(Math.cos(e),-Math.sin(e),0,0,Math.sin(e),Math.cos(e),0,0,0,0,1,0,0,0,0,1)}translate(e){return e instanceof r&&(e=e.toArray()),this.setAll(1,0,0,e[0],0,1,0,e[1],0,0,1,0,0,0,0,1)}scale(e){return e instanceof r?e=e.toArray():e instanceof Float32Array||(e=new Float32Array([e,e])),this.setAll(e[0],0,0,0,0,e[1],0,0,0,0,1,0,0,0,0,1)}mult(e,t){let i=new Float32Array(16);for(let s=0;s<4;s++)for(let a=0;a<4;a++){let o=0;for(let d=0;d<4;d++)o+=this.get(d,s)*e.get(a,d);i[a*4+s]=o}return t!==void 0?t.setAll(...i):new X().setAll(...i)}static MULT(...e){let t=X.IDENTITY;for(let i=0;i<e.length;i++)t.mult(e[i],t);return t}toArray(){return this.mat}toString(){return`|${this.mat[0].toFixed(2)}, ${this.mat[1].toFixed(2)}, ${this.mat[2].toFixed(2)}, ${this.mat[3].toFixed(2)}|
|${this.mat[4].toFixed(2)}, ${this.mat[5].toFixed(2)}, ${this.mat[6].toFixed(2)}, ${this.mat[7].toFixed(2)}|
|${this.mat[8].toFixed(2)}, ${this.mat[9].toFixed(2)}, ${this.mat[10].toFixed(2)}, ${this.mat[11].toFixed(2)}|
|${this.mat[12].toFixed(2)}, ${this.mat[13].toFixed(2)}, ${this.mat[14].toFixed(2)}, ${this.mat[15].toFixed(2)}|`}}class _t{constructor(e){this.programKey=e,this.resourceManager=D.getInstance()}getOptions(e){return{}}}class ht extends _t{constructor(e){super(e),this.scale=X.IDENTITY,this.rotation=X.IDENTITY,this.translation=X.IDENTITY}}class gi extends ht{constructor(e){super(e),this.resourceManager=D.getInstance()}initBufferObject(){this.bufferObjectKey="label",this.resourceManager.createBuffer(this.bufferObjectKey)}render(e,t){const i=t.backgroundColor.toWebGL(),s=t.borderColor.toWebGL(),a=this.resourceManager.getShaderProgram(this.programKey),o=this.resourceManager.getBuffer(this.bufferObjectKey);e.useProgram(a);const d=this.getVertices(t.size.x,t.size.y),h=d.BYTES_PER_ELEMENT;e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);const c=e.getAttribLocation(a,"a_Position");e.vertexAttribPointer(c,2,e.FLOAT,!1,2*h,0*h),e.enableVertexAttribArray(c);const u=e.getUniformLocation(a,"u_BackgroundColor");e.uniform4fv(u,i);const y=e.getUniformLocation(a,"u_BorderColor");e.uniform4fv(y,s);const m=e.getUniformLocation(a,"u_MaxSize");e.uniform2f(m,-d[0],d[1]);let f=Math.max(t.size.x,t.size.y);const A=e.getUniformLocation(a,"u_BorderWidth");e.uniform1f(A,t.borderWidth/f);const T=e.getUniformLocation(a,"u_BorderRadius");e.uniform1f(T,t.borderRadius/f);let S=new r(f,f).scale(2/t.worldSize.x,2/t.worldSize.y);const W=(t.position.x-t.origin.x-t.worldSize.x/2)/f,K=-(t.position.y-t.origin.y-t.worldSize.y/2)/f;this.translation.translate(new Float32Array([W,K])),this.scale.scale(S),this.rotation.rotate(t.rotation);let se=X.MULT(this.translation,this.scale,this.rotation);const ne=e.getUniformLocation(a,"u_Transform");e.uniformMatrix4fv(ne,!1,se.toArray()),e.drawArrays(e.TRIANGLE_STRIP,0,4)}getVertices(e,t){let i,s;return t>e?(s=.5,i=e/(2*t)):(i=.5,s=t/(2*e)),new Float32Array([-i,s,-i,-s,i,s,i,-s])}getOptions(e){return{position:e.position,backgroundColor:e.calculateBackgroundColor(),borderColor:e.calculateBorderColor(),borderWidth:e.borderWidth,borderRadius:e.borderRadius,size:e.size,rotation:e.rotation}}}class Tt{static toWebGLCoords(e,t,i){return new Float32Array([w.changeRange(e.x,t.x,t.x+i.x,-1,1),w.changeRange(e.y,t.y,t.y+i.y,1,-1)])}static toWebGLScale(e,t){return new Float32Array([2*e.x/t.x,2*e.y/t.y])}static toWebGLColor(e){return new Float32Array([w.changeRange(e.r,0,255,0,1),w.changeRange(e.g,0,255,0,1),w.changeRange(e.b,0,255,0,1),e.a])}}class pi extends _t{constructor(e){super(e)}initBufferObject(){this.bufferObjectKey="point",this.resourceManager.createBuffer(this.bufferObjectKey)}render(e,t){let i=Tt.toWebGLCoords(t.position,t.origin,t.worldSize),s=Tt.toWebGLColor(t.color);const a=this.resourceManager.getShaderProgram(this.programKey),o=this.resourceManager.getBuffer(this.bufferObjectKey);e.useProgram(a);const d=i,h=d.BYTES_PER_ELEMENT;e.bindBuffer(e.ARRAY_BUFFER,o),e.bufferData(e.ARRAY_BUFFER,d,e.STATIC_DRAW);const c=e.getAttribLocation(a,"a_Position");e.vertexAttribPointer(c,2,e.FLOAT,!1,2*h,0*h),e.enableVertexAttribArray(c);const u=e.getUniformLocation(a,"u_Color");e.uniform4fv(u,s);const y=e.getUniformLocation(a,"u_PointSize");e.uniform1f(y,t.pointSize),e.drawArrays(e.POINTS,0,1)}getOptions(e){return{position:e.position,color:e.color,pointSize:e.size}}}class fi extends ht{constructor(e){super(e),this.resourceManager=D.getInstance()}initBufferObject(){this.bufferObjectKey="rect",this.resourceManager.createBuffer(this.bufferObjectKey)}render(e,t){const i=t.color.toWebGL(),s=this.resourceManager.getShaderProgram(this.programKey),a=this.resourceManager.getBuffer(this.bufferObjectKey);e.useProgram(s);const o=this.getVertices(t.size.x,t.size.y),d=o.BYTES_PER_ELEMENT;e.bindBuffer(e.ARRAY_BUFFER,a),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW);const h=e.getAttribLocation(s,"a_Position");e.vertexAttribPointer(h,2,e.FLOAT,!1,2*d,0*d),e.enableVertexAttribArray(h);const c=e.getUniformLocation(s,"u_Color");e.uniform4fv(c,i);let u=Math.max(t.size.x,t.size.y),y=new r(u,u).scale(2/t.worldSize.x,2/t.worldSize.y);const m=(t.position.x-t.origin.x-t.worldSize.x/2)/u,f=-(t.position.y-t.origin.y-t.worldSize.y/2)/u;this.translation.translate(new Float32Array([m,f])),this.scale.scale(y),this.rotation.rotate(t.rotation);let A=X.MULT(this.translation,this.scale,this.rotation);const T=e.getUniformLocation(s,"u_Transform");e.uniformMatrix4fv(T,!1,A.toArray()),e.drawArrays(e.TRIANGLE_STRIP,0,4)}getVertices(e,t){let i,s;return t>e?(s=.5,i=e/(2*t)):(i=.5,s=t/(2*e)),new Float32Array([-i,s,-i,-s,i,s,i,-s])}getOptions(e){return{position:e.position,color:e.color,size:e.size,rotation:e.rotation}}}class mi extends ht{constructor(e){super(e),this.resourceManager=D.getInstance()}initBufferObject(){this.bufferObjectKey="sprite",this.resourceManager.createBuffer(this.bufferObjectKey)}render(e,t){const i=this.resourceManager.getShaderProgram(this.programKey),s=this.resourceManager.getBuffer(this.bufferObjectKey),a=this.resourceManager.getTexture(t.imageKey);e.useProgram(i);const o=this.getVertices(t.size.x,t.size.y,t.scale),d=o.BYTES_PER_ELEMENT;e.bindBuffer(e.ARRAY_BUFFER,s),e.bufferData(e.ARRAY_BUFFER,o,e.STATIC_DRAW);const h=e.getAttribLocation(i,"a_Position");e.vertexAttribPointer(h,2,e.FLOAT,!1,4*d,0*d),e.enableVertexAttribArray(h);const c=e.getAttribLocation(i,"a_TexCoord");e.vertexAttribPointer(c,2,e.FLOAT,!1,4*d,2*d),e.enableVertexAttribArray(c);let u=Math.max(t.size.x,t.size.y),y=new r(u,u).scale(2/t.worldSize.x,2/t.worldSize.y);const m=(t.position.x-t.origin.x-t.worldSize.x/2)/u,f=-(t.position.y-t.origin.y-t.worldSize.y/2)/u;this.translation.translate(new Float32Array([m,f])),this.scale.scale(y),this.rotation.rotate(t.rotation);let A=X.MULT(this.translation,this.scale,this.rotation);const T=e.getUniformLocation(i,"u_Transform");e.uniformMatrix4fv(T,!1,A.toArray());const S=e.getUniformLocation(i,"u_Sampler");e.uniform1i(S,a);const W=e.getUniformLocation(i,"u_texShift");e.uniform2fv(W,t.texShift);const K=e.getUniformLocation(i,"u_texScale");e.uniform2fv(K,t.texScale),e.drawArrays(e.TRIANGLE_STRIP,0,4)}getVertices(e,t,i){let s,a;return t>e?(a=.5,s=e/(2*t)):(s=.5,a=t/(2*e)),s*=i[0],a*=i[1],new Float32Array([-s,a,0,0,-s,-a,0,1,s,a,1,0,s,-a,1,1])}getOptions(e){let t,i;if(e instanceof Qe){let a=e.animation.getIndexAndAdvanceAnimation(),o=e.getAnimationOffset(a);t=new Float32Array([o.x/(e.cols*e.size.x),o.y/(e.rows*e.size.y)]),i=new Float32Array([1/e.cols,1/e.rows])}else t=new Float32Array([0,0]),i=new Float32Array([1,1]);return{position:e.position,rotation:e.rotation,size:e.size,scale:e.scale.toArray(),imageKey:e.imageId,texShift:t,texScale:i}}}class yi extends L{}class U extends yi{constructor(){super(...arguments),this.registryItems=new Array}preload(){const e=D.getInstance();this.registerAndPreloadItem(U.POINT_SHADER,pi,"builtin/shaders/point.vshader","builtin/shaders/point.fshader"),this.registerAndPreloadItem(U.RECT_SHADER,fi,"builtin/shaders/rect.vshader","builtin/shaders/rect.fshader"),this.registerAndPreloadItem(U.SPRITE_SHADER,mi,"builtin/shaders/sprite.vshader","builtin/shaders/sprite.fshader"),this.registerAndPreloadItem(U.LABEL_SHADER,gi,"builtin/shaders/label.vshader","builtin/shaders/label.fshader");for(let t of this.registryItems){const i=new t.constr(t.key);i.initBufferObject(),this.add(t.key,i),t.preload!==void 0&&e.shader(t.key,t.preload.vshaderLocation,t.preload.fshaderLocation)}}registerAndPreloadItem(e,t,i,s){let a=new wi;a.vshaderLocation=i,a.fshaderLocation=s;let o=new At;o.key=e,o.constr=t,o.preload=a,this.registryItems.push(o)}registerItem(e,t){let i=new At;i.key=e,i.constr=t,this.registryItems.push(i)}}U.POINT_SHADER="point";U.RECT_SHADER="rect";U.SPRITE_SHADER="sprite";U.LABEL_SHADER="label";class At{}class wi{}class oe{static preload(){this.shaders.preload(),this.registries.forEach(e=>this.registries.get(e).preload())}static addCustomRegistry(e,t){this.registries.add(e,t)}static getRegistry(e){return this.registries.get(e)}}oe.shaders=new U;oe.registries=new L;class Si extends Mt{initializeCanvas(e,t,i){e.width=t,e.height=i,this.worldSize=r.ZERO,this.worldSize.x=t,this.worldSize.y=i,this.gl=e.getContext("webgl"),this.gl.viewport(0,0,e.width,e.height),this.gl.disable(this.gl.DEPTH_TEST),this.gl.enable(this.gl.BLEND),this.gl.blendFunc(this.gl.SRC_ALPHA,this.gl.ONE_MINUS_SRC_ALPHA),this.gl.enable(this.gl.CULL_FACE),D.getInstance().useWebGL(!0,this.gl);let s=document.getElementById("text-canvas");return s.hidden=!1,this.textCtx=s.getContext("2d"),s.height=i,s.width=t,this.gl}render(e,t,i){for(let s of e)this.renderNode(s);i.forEach(s=>{i.get(s).isHidden()||i.get(s).getItems().forEach(a=>this.renderNode(a))})}clear(e){this.gl.clearColor(e.r,e.g,e.b,e.a),this.gl.clear(this.gl.COLOR_BUFFER_BIT|this.gl.DEPTH_BUFFER_BIT),this.textCtx.clearRect(0,0,this.worldSize.x,this.worldSize.y)}renderNode(e){this.origin=this.scene.getViewTranslation(e),this.zoom=this.scene.getViewScale(),e.hasCustomShader?this.renderCustom(e):e instanceof ke?this.renderGraphic(e):e instanceof Re?e instanceof Qe?this.renderAnimatedSprite(e):this.renderSprite(e):e instanceof Ve&&this.renderUIElement(e)}renderSprite(e){let t=oe.shaders.get(U.SPRITE_SHADER),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i)}renderAnimatedSprite(e){let t=oe.shaders.get(U.SPRITE_SHADER),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i)}renderGraphic(e){if(e instanceof je){let t=oe.shaders.get(U.POINT_SHADER),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i)}else if(e instanceof Be){let t=oe.shaders.get(U.RECT_SHADER),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i)}}renderTilemap(e){throw new Error("Method not implemented.")}renderUIElement(e){if(e instanceof _e){let t=oe.shaders.get(U.LABEL_SHADER),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i),this.textCtx.setTransform(1,0,0,1,(e.position.x-this.origin.x)*this.zoom,(e.position.y-this.origin.y)*this.zoom),this.textCtx.rotate(-e.rotation);let s=this.textCtx.globalAlpha;this.textCtx.globalAlpha=e.alpha,this.textCtx.font=e.getFontString();let a=e.calculateTextOffset(this.textCtx);this.textCtx.fillStyle=e.calculateTextColor(),this.textCtx.globalAlpha=e.textColor.a,this.textCtx.fillText(e.text,a.x-e.size.x/2,a.y-e.size.y/2),this.textCtx.globalAlpha=s,this.textCtx.setTransform(1,0,0,1,0,0)}}renderCustom(e){let t=oe.shaders.get(e.customShaderKey),i=this.addOptions(t.getOptions(e),e);t.render(this.gl,i)}addOptions(e,t){e.worldSize=this.worldSize;let i=t.getLayer(),s=new r(1,1);return i instanceof Ie&&(s=i.parallax),e.origin=this.origin.clone().mult(s),e}}class xi{constructor(e){ui.setup(),this.gameOptions=ot.parse(e),this.showDebug=this.gameOptions.showDebug,this.showStats=this.gameOptions.showStats,this.loop=new ci,this.GAME_CANVAS=document.getElementById("game-canvas"),this.DEBUG_CANVAS=document.getElementById("debug-canvas"),this.WIDTH=this.gameOptions.canvasSize.x,this.HEIGHT=this.gameOptions.canvasSize.y,this.gameOptions.useWebGL?this.renderingManager=new Si:this.renderingManager=new li,this.initializeGameWindow(),this.ctx=this.renderingManager.initializeCanvas(this.GAME_CANVAS,this.WIDTH,this.HEIGHT),this.clearColor=new g(this.gameOptions.clearColor.r,this.gameOptions.clearColor.g,this.gameOptions.clearColor.b),F.initializeDebugCanvas(this.DEBUG_CANVAS,this.WIDTH,this.HEIGHT),ie.initStats(),this.gameOptions.showStats&&(document.getElementById("stats").hidden=!1);const t=new r(this.WIDTH,this.HEIGHT);this.viewport=new $t(t,this.gameOptions.zoomLevel),this.eventQueue=te.getInstance(),this.inputHandler=new Vt(this.GAME_CANVAS),l.initialize(this.viewport,this.gameOptions.inputs),this.recorder=new Qt,this.resourceManager=D.getInstance(),this.sceneManager=new Jt(this.viewport,this.renderingManager),this.audioManager=Me.getInstance()}initializeGameWindow(){const e=document.getElementById("game-window");e.style.width=this.WIDTH+"px",e.style.height=this.HEIGHT+"px"}getSceneManager(){return this.sceneManager}start(e,t){this.loop.doUpdate=i=>this.update(i),this.loop.doRender=()=>this.render(),oe.preload(),this.resourceManager.loadResourcesFromQueue(()=>{console.log("Finished Preload - loading first scene"),this.sceneManager.changeToScene(e,{},t),this.loop.start()})}update(e){try{this.eventQueue.update(e),l.update(e),this.recorder.update(e),this.sceneManager.update(e),this.audioManager.update(e),this.resourceManager.update(e)}catch(t){this.loop.pause(),console.warn("Uncaught Error in Update - Crashing gracefully"),console.error(t)}}render(){try{F.clearCanvas(),this.renderingManager.clear(this.clearColor),this.sceneManager.render(),l.isKeyJustPressed("g")&&(this.showDebug=!this.showDebug),this.showDebug&&F.render(),this.showStats&&ie.render()}catch(e){this.loop.pause(),console.warn("Uncaught Error in Render - Crashing gracefully"),console.error(e)}}}class Xe{constructor(){this.receiver=new ye,this.emitter=new pe,this.groupMap=new L,this.groupNames=new Array}destroy(){this.receiver.destroy()}setGroup(e,t){e.group=this.groupMap.get(t)}getGroupNumber(e){return this.groupMap.has(e)?this.groupMap.get(e):0}getGroupNames(e){if(e===-1)return[Xe.DEFAULT_GROUP];{let t=1,i=[];for(let s=0;s<32;s++)t&e&&i.push(this.groupNames[s]),t=t<<1}}}Xe.DEFAULT_GROUP="Default";class tt{constructor(e,t,i,s,a){this.area=e,this.collider=t,this.other=i,this.type=s,this.tile=a}}class vi extends Xe{constructor(e){super(),this.staticNodes=new Array,this.dynamicNodes=new Array,this.tilemaps=new Array,this.collisionMasks=new Array(32),this.parseOptions(e)}parseOptions(e){if(e.groupNames!==void 0&&e.collisions!==void 0)for(let t=0;t<e.groupNames.length;t++){let i=e.groupNames[t];this.groupNames[t]=i,this.groupMap.set(i,1<<t);let s=0;for(let a=0;a<e.collisions[t].length;a++)e.collisions[t][a]&&(s|=1<<a);this.collisionMasks[t]=s}}registerObject(e){e.isStatic?this.staticNodes.push(e):this.dynamicNodes.push(e)}deregisterObject(e){if(e.isStatic){const t=this.staticNodes.indexOf(e);this.staticNodes.splice(t,1)}else{const t=this.dynamicNodes.indexOf(e);this.dynamicNodes.splice(t,1)}}registerTilemap(e){this.tilemaps.push(e)}deregisterTilemap(e){const t=this.tilemaps.indexOf(e);this.tilemaps.splice(t,1)}update(e){for(let t of this.dynamicNodes){if(t.onGround=!1,t.onCeiling=!1,t.onWall=!1,t.collidedWithTilemap=!1,t.isColliding=!1,!t.active)continue;if(t.moving)t.sweptRect.sweep(t._velocity,t.collisionShape.center,t.collisionShape.halfSize);else{t._velocity.zero();continue}let i=new Array,s=t.group===-1?-1:Math.log2(t.group);for(let a of this.staticNodes){if(!a.active)continue;let o=a.collisionShape.getBoundingRect(),d=t.sweptRect.overlapArea(o);d>0&&i.push(new tt(d,o,a,"GameNode",null))}for(let a of this.dynamicNodes){if(t===a||!a.active)continue;let o=a.collisionShape.getBoundingRect(),d=t.sweptRect.overlapArea(o);d>0&&i.push(new tt(d,o,a,"GameNode",null))}for(let a of this.tilemaps)a.active&&a instanceof Ge&&this.collideWithOrthogonalTilemap(t,a,i);i=i.sort((a,o)=>o.area-a.area);for(let a of i){if(s!==-1&&a.other.group!==-1&&!(this.collisionMasks[s]&a.other.group))continue;const o=t.collisionShape.center,d=t._velocity,h=t.collisionShape.halfSize,c=a.collider,u=c.intersectSegment(t.collisionShape.center,t._velocity,t.collisionShape.halfSize);if(a.hit=u,u!==null){let y=u.nearTimes.x,m=u.nearTimes.y;y<1&&(o.y===c.top-h.y||o.y===c.bottom+h.y)&&d.x!==0?y=1:m<1&&(o.x===c.left-h.x||o.x===c.right+h.x)&&d.y!==0&&(m=1),u.nearTimes.x>=0&&u.nearTimes.x<1&&(a.type==="Tilemap"||a.other.isCollidable)&&(t._velocity.x=t._velocity.x*y,t.isColliding=!0),u.nearTimes.y>=0&&u.nearTimes.y<1&&(a.type==="Tilemap"||a.other.isCollidable)&&(t._velocity.y=t._velocity.y*m,t.isColliding=!0)}}for(let a of i){if(a.other.isTrigger&&a.other.triggerMask&t.group){let o=Math.floor(Math.log2(t.group));this.emitter.fireEvent(a.other.triggerEnters[o],{node:t.id,other:a.other.id})}if(!(s!==-1&&a.other.group!==-1&&!(this.collisionMasks[s]&a.other.group))&&(a.type==="Tilemap"||a.other.isCollidable)){let o=a.collider.touchesAABBWithoutCorners(t.collisionShape.getBoundingRect());o!==null&&a.hit!==null&&(a.type=="Tilemap"&&(t.collidedWithTilemap=!0),o.y===-1?t.onGround=!0:o.y===1?t.onCeiling=!0:t.onWall=!0)}}t.finishMove()}}collideWithOrthogonalTilemap(e,t,i){let s=new r(e.sweptRect.left,e.sweptRect.top),a=new r(e.sweptRect.right,e.sweptRect.bottom),o=t.getColRowAt(s),d=t.getColRowAt(a),h=t.getTileSize();for(let c=o.x;c<=d.x;c++)for(let u=o.y;u<=d.y;u++)if(t.isTileCollidable(c,u)){let y=new r(c*h.x+h.x/2,u*h.y+h.y/2),m=new z(y,h.scaled(1/2)),f=e.sweptRect.overlapArea(m);f>0&&i.push(new tt(f,m,t,"Tilemap",new r(c,u)))}}}class Ei{constructor(e,t){this.viewport=e,this.scene=t,this.nodeMap=new Array,this.idCounter=0}addNode(e){return this.nodeMap[e.id]=e,this.addNodeSpecific(e,this.idCounter),this.idCounter+=1,this.idCounter-1}removeNode(e){this.nodeMap[e.id]=void 0,this.removeNodeSpecific(e,e.id)}getNode(e){return this.nodeMap[e]}getNodesAt(e,t=null){return e instanceof r?this.getNodesAtCoords(e.x,e.y):this.getNodesAtCoords(e,t)}getAllNodes(){let e=new Array;for(let t=0;t<this.nodeMap.length;t++)this.nodeMap[t]!==void 0&&e.push(this.nodeMap[t]);return e}}class Ti extends Ei{constructor(e,t){super(e,t),this.nodeList=new Array}addNodeSpecific(e,t){this.nodeList.push(e)}removeNodeSpecific(e,t){let i=this.nodeList.indexOf(e);i>-1&&this.nodeList.splice(i,1)}getNodesAtCoords(e,t){let i=[];for(let s of this.nodeList)s.contains(e,t)&&i.push(s);return i}getNodesInRegion(e){let t=performance.now(),i=[];for(let a of this.nodeList)e.overlaps(a.boundary)&&i.push(a);let s=performance.now();return ie.log("sgquery",s-t),i}update(e){let t=performance.now();for(let s of this.nodeList)s.getLayer().isPaused()||s.update(e);let i=performance.now();ie.log("sgupdate",i-t)}render(e){}getVisibleSet(){let e=new Array;for(let t of this.nodeList)!t.getLayer().isHidden()&&t.visible&&this.viewport.includes(t)&&e.push(t);return e}}var le;(function(n){n.POINT="POINT",n.RECT="RECT",n.LINE="LINE",n.PARTICLE="PARTICLE"})(le||(le={}));var N;(function(n){n.BUTTON="BUTTON",n.LABEL="LABEL",n.SLIDER="SLIDER",n.TEXT_INPUT="TEXTINPUT"})(N||(N={}));class Ai extends je{constructor(e,t,i){super(e),this.inUse=!1,this.mass=i}setParticleActive(e,t){this.age=e,this.inUse=!0,this.visible=!0,this.position=t}decrementAge(e){this.age-=e}setParticleInactive(){this.inUse=!1,this.visible=!1}set velY(e){this.vel.y=e}get velY(){return this.vel.y}}class bi{constructor(){this.addUIElement=(e,t,i)=>{let s=this.scene.getLayer(t),a;switch(e){case N.BUTTON:a=this.buildButton(i);break;case N.LABEL:a=this.buildLabel(i);break;case N.SLIDER:a=this.buildSlider(i);break;case N.TEXT_INPUT:a=this.buildTextInput(i);break;default:throw`UIElementType '${e}' does not exist, or is registered incorrectly.`}return a.setScene(this.scene),a.id=this.scene.generateId(),this.scene.getSceneGraph().addNode(a),s.addNode(a),a},this.addSprite=(e,t)=>{let i=this.scene.getLayer(t),s=new Re(e);return s.setScene(this.scene),s.id=this.scene.generateId(),this.scene.isParallaxLayer(t)||this.scene.isUILayer(t)||this.scene.getSceneGraph().addNode(s),i.addNode(s),s},this.addAnimatedSprite=(e,t)=>{let i=this.scene.getLayer(t),s=this.resourceManager.getSpritesheet(e),a=new Qe(s);return a.setScene(this.scene),a.id=this.scene.generateId(),this.scene.isParallaxLayer(t)||this.scene.isUILayer(t)||this.scene.getSceneGraph().addNode(a),i.addNode(a),a},this.addGraphic=(e,t,i)=>{let s=this.scene.getLayer(t),a;switch(e){case le.POINT:a=this.buildPoint(i);break;case le.LINE:a=this.buildLine(i);break;case le.RECT:a=this.buildRect(i);break;case le.PARTICLE:a=this.buildParticle(i);break;default:throw`GraphicType '${e}' does not exist, or is registered incorrectly.`}return a.setScene(this.scene),a.id=this.scene.generateId(),this.scene.isParallaxLayer(t)||this.scene.isUILayer(t)||this.scene.getSceneGraph().addNode(a),s.addNode(a),a}}init(e){this.scene=e,this.resourceManager=D.getInstance()}buildButton(e){return this.checkIfPropExists("Button",e,"position",r,"Vec2"),this.checkIfPropExists("Button",e,"text","string"),new It(e.position,e.text)}buildLabel(e){return this.checkIfPropExists("Label",e,"position",r,"Vec2"),this.checkIfPropExists("Label",e,"text","string"),new _e(e.position,e.text)}buildSlider(e){this.checkIfPropExists("Slider",e,"position",r,"Vec2");let t=0;return e.value!==void 0&&(t=e.value),new Rt(e.position,t)}buildTextInput(e){return this.checkIfPropExists("TextInput",e,"position",r,"Vec2"),new Dt(e.position)}buildPoint(e){return this.checkIfPropExists("Point",e,"position",r,"Vec2"),new je(e.position)}buildParticle(e){return this.checkIfPropExists("Particle",e,"position",r,"Vec2"),this.checkIfPropExists("Particle",e,"size",r,"Vec2"),this.checkIfPropExists("Particle",e,"mass","number","number"),new Ai(e.position,e.size,e.mass)}buildLine(e){return this.checkIfPropExists("Line",e,"start",r,"Vec2"),this.checkIfPropExists("Line",e,"end",r,"Vec2"),new kt(e.start,e.end)}buildRect(e){return this.checkIfPropExists("Rect",e,"position",r,"Vec2"),this.checkIfPropExists("Rect",e,"size",r,"Vec2"),new Be(e.position,e.size)}checkIfPropExists(e,t,i,s,a){if(!t||t[i]===void 0)throw`${e} object requires argument ${i} of type ${a}, but none was provided.`;if(typeof s=="string"){if(typeof t[i]!==s)throw`${e} object requires argument ${i} of type ${s}, but provided ${i} was not of type ${s}.`}else if(s instanceof Function){if(!(t[i]instanceof s))throw`${e} object requires argument ${i} of type ${a}, but provided ${i} was not of type ${a}.`}else throw`${e} object requires argument ${i} of type ${a}, but provided ${i} was not of type ${a}.`}}class Li{constructor(e){this.initFromTiledData(e)}initFromTiledData(e){this.numRows=e.tilecount/e.columns,this.numCols=e.columns,this.startIndex=e.firstgid,this.endIndex=this.startIndex+e.tilecount-1,this.tileSize=new r(e.tilewidth,e.tilewidth),this.imageKey=e.image,this.imageSize=new r(e.imagewidth,e.imageheight)}getImageKey(){return this.imageKey}getImageOffsetForTile(e){let t=e-this.startIndex,i=Math.floor(t/this.numCols),s=t%this.numCols,a=this.tileSize.x,o=this.tileSize.y,d=s*a,h=i*o;return new r(d,h)}getStartIndex(){return this.startIndex}getTileSize(){return this.tileSize}getNumRows(){return this.numRows}getNumCols(){return this.numCols}getTileCount(){return this.endIndex-this.startIndex+1}hasTile(e){return e>=this.startIndex&&e<=this.endIndex}renderTile(e,t,i,s,a,o,d){let h=D.getInstance().getImage(this.imageKey),c=t-this.startIndex,u=Math.floor(c/this.numCols),y=c%this.numCols,m=this.tileSize.x,f=this.tileSize.y,A=y*m,T=u*f,S=Math.floor(i%s*m*o.x),W=Math.floor(Math.floor(i/s)*f*o.y);e.drawImage(h,A,T,m,f,Math.floor((S-a.x)*d),Math.floor((W-a.y)*d),Math.ceil(m*o.x*d),Math.ceil(f*o.y*d))}}class bt{constructor(e,t){this.y=e,this.next=null,this.weight=t||1}}const nt=100;class Pi{constructor(e=!1){this.directed=e,this.weighted=!1,this.numVertices=0,this.numEdges=0,this.edges=new Array(nt),this.degree=new Array(nt)}addNode(){return this.numVertices++,this.numVertices}addEdge(e,t,i){let s=new bt(t,i);this.edges[e]&&(s.next=this.edges[e]),this.edges[e]=s,this.directed||(s=new bt(e,i),this.edges[t]&&(s.next=this.edges[t]),this.edges[t]=s),this.numEdges+=1}edgeExists(e,t){let i=this.edges[e];for(;i!==null;){if(i.y===t)return!0;i=i.next}}getEdges(e){return this.edges[e]}getDegree(e){return this.degree[e]}nodeToString(e){return"Node "+e}toString(){let e="";for(let t=0;t<this.numVertices;t++){let i=this.edges[t],s="";for(;i!=null;)s+=i.y.toString(),this.weighted&&(s+=" ("+i.weight+")"),i.next!==null&&(s+=", "),i=i.next;e+=this.nodeToString(t)+": "+s+`
`}return e}}class Ci extends Pi{constructor(e=!1){super(e),this.debugRender=()=>{},this.positions=new Array(nt)}addPositionedNode(e){return this.positions[this.numVertices]=e,this.addNode()}setNodePosition(e,t){this.positions[e]=t;for(let i=0;i<this.numEdges;i++){let s=this.edges[i];for(;s!==null;)(i===e||s.y===e)&&(s.weight=this.positions[i].distanceTo(this.positions[s.y])),s=s.next}}getNodePosition(e){return this.positions[e]}addEdge(e,t){if(!this.positions[e]||!this.positions[t])throw"Can't add edge to un-positioned node!";let i=this.positions[e].distanceTo(this.positions[t]);super.addEdge(e,t,i)}nodeToString(e){return"Node "+e+" - "+this.positions[e].toString()}}class Nt{constructor(e=100){this.MAX_ELEMENTS=e,this.stack=new Array(this.MAX_ELEMENTS),this.head=-1}push(e){if(this.head+1===this.MAX_ELEMENTS)throw"Stack full - cannot add element";this.head+=1,this.stack[this.head]=e}pop(){if(this.head===-1)throw"Stack empty - cannot remove element";return this.head-=1,this.stack[this.head+1]}peek(){if(this.head===-1)throw"Stack empty - cannot get element";return this.stack[this.head]}isEmpty(){return this.head===-1}clear(){this.forEach((e,t)=>delete this.stack[t]),this.head=-1}size(){return this.head+1}forEach(e){let t=0;for(;t<=this.head;)e(this.stack[t],t),t+=1}toString(){let e="";return this.forEach((t,i)=>{let s=t.toString();i!==0&&(s+=" -> "),e=s+e}),"Top -> "+e}}class Mi{static djikstra(e,t){let i,s,a=new Array(e.numVertices),o=new Array(e.numVertices),d=new Array(e.numVertices),h,c,u,y;for(i=0;i<e.numVertices;i++)a[i]=!1,o[i]=1/0,d[i]=-1;for(o[t]=0,h=t;!a[h];){for(a[h]=!0,s=e.edges[h];s!==null;)c=s.y,u=s.weight,o[c]>o[h]+u&&(o[c]=o[h]+u,d[c]=h),s=s.next;for(h=0,y=1/0,i=0;i<=e.numVertices;i++)!a[i]&&y>o[i]&&(y=o[i],h=i)}return d}}class Lt{constructor(e){this.path=e,this.currentMoveDirection=r.ZERO,this.distanceThreshold=4}isDone(){return this.path.isEmpty()}getMoveDirection(e){return e.position.dirTo(this.path.peek())}handlePathProgress(e){e.position.distanceSqTo(this.path.peek())<this.distanceThreshold*this.distanceThreshold&&this.path.pop()}toString(){return this.path.toString()}}class Ii{constructor(e){this.graph=e}getNavigationPath(e,t,i){let s=this.getClosestNode(e),a=this.getClosestNode(t),o=new Nt(this.graph.numVertices);if(o.push(t.clone()),i)return new Lt(o);o.push(this.graph.positions[a]);let d=Mi.djikstra(this.graph,s),h=a;for(;d[h]!==-1;)o.push(this.graph.positions[d[h]]),h=d[h];return new Lt(o)}getClosestNode(e){let t=this.graph.numVertices,i=1,s=0,a=e.distanceSqTo(this.graph.positions[0]);for(;i<t;){let o=e.distanceSqTo(this.graph.positions[i]);o<a&&(a=o,s=i),i++}return s}}class Ri{constructor(){this.add=(e,t=new r(1,1))=>{let i=this.resourceManager.getTilemap(e),s;i.orientation,s=Ge;let a=new Array,o=new Array,d=new Array;for(let h of i.tilesets)h.image?o.push(new Li(h)):(h.tiles.forEach(c=>c.id+=h.firstgid),d.push(...h.tiles));for(let h of i.layers){let c,u=!1,y=0;if(h.properties)for(let m of h.properties)m.name==="Parallax"?u=m.value:m.name==="Depth"&&(y=m.value);if(u?c=this.scene.addParallaxLayer(h.name,new r(1,1),y):c=this.scene.addLayer(h.name,y),h.type==="tilelayer"){let m=new s(i,h,o,t);if(m.id=this.scene.generateId(),m.setScene(this.scene),this.tilemaps.push(m),c.addNode(m),m.isCollidable&&(m.addPhysics(),h.properties))for(let f of h.properties)f.name==="Group"&&m.setGroup(f.value)}else{let m=!1,f,A;if(h.properties)for(let T of h.properties)T.name==="NavmeshPoints"?m=!0:T.name==="name"?f=T.value:T.name==="edges"&&(A=T.value);if(m){let T=new Ci;for(let S of h.objects)T.addPositionedNode(new r(S.x,S.y));for(let S of A)T.addEdge(S.from,S.to);this.scene.getNavigationManager().addNavigableEntity(f,new Ii(T));continue}for(let T of h.objects){let S=!1,W=!1,K=!1,se=null,ne=null,Y=null,V="";if(T.properties)for(let b of T.properties)b.name==="HasPhysics"?S=b.value:b.name==="Collidable"?W=b.value:b.name==="Group"?V=b.value:b.name==="IsTrigger"?K=b.value:b.name==="TriggerGroup"?Y=b.value:b.name==="TriggerOnEnter"?se=b.value:b.name==="TriggerOnExit"&&(ne=b.value);let R;for(let b of o)if(b.hasTile(T.gid)){let Se=b.getImageKey(),ze=b.getImageOffsetForTile(T.gid);R=this.scene.add.sprite(Se,h.name);let Je=b.getTileSize().clone();R.position.set((T.x+Je.x/2)*t.x,(T.y-Je.y/2)*t.y),R.setImageOffset(ze),R.size.copy(Je),R.scale.set(t.x,t.y)}if(!R){for(let b of d)if(T.gid===b.id){let Se=b.image;R=this.scene.add.sprite(Se,h.name),R.position.set((T.x+b.imagewidth/2)*t.x,(T.y-b.imageheight/2)*t.y),R.scale.set(t.x,t.y)}}S&&(R.addPhysics(R.boundary.clone(),r.ZERO,W,!0),R.setGroup(V),K&&Y!==null&&R.setTrigger(Y,se,ne))}}a.push(c)}return a}}init(e,t){this.scene=e,this.tilemaps=t,this.resourceManager=D.getInstance()}}class Di{constructor(e,t){this.canvasNodeFactory=new bi,this.tilemapFactory=new Ri,this.canvasNodeFactory.init(e),this.tilemapFactory.init(e,t)}uiElement(e,t,i){return this.canvasNodeFactory.addUIElement(e,t,i)}sprite(e,t){return this.canvasNodeFactory.addSprite(e,t)}animatedSprite(e,t){return this.canvasNodeFactory.addAnimatedSprite(e,t)}graphic(e,t,i){return this.canvasNodeFactory.addGraphic(e,t,i)}tilemap(e,t){return this.tilemapFactory.add(e,t)}}class ki{constructor(){this.navigableEntities=new L}addNavigableEntity(e,t){this.navigableEntities.add(e,t)}getPath(e,t,i,s){return this.navigableEntities.get(e).getNavigationPath(t.clone(),i.clone(),s)}}class _i{constructor(){this.actors=new Array,this.registeredAI=new L}registerActor(e){this.actors.push(e)}removeActor(e){let t=this.actors.indexOf(e);t!==-1&&this.actors.splice(t,1)}registerAI(e,t){this.registeredAI.add(e,t)}generateAI(e){if(this.registeredAI.has(e))return new(this.registeredAI.get(e));throw`Cannot create AI with name ${e}, no AI with that name is registered`}update(e){this.actors.forEach(t=>{t.aiActive&&t.ai.update(e)})}}class lt{static parse(e){let t=new lt;return e.physics===void 0?t.physics={groups:void 0,collisions:void 0}:t.physics=e.physics,t}}class De{constructor(){this.timers=new Array}static getInstance(){return this.instance||(this.instance=new De),this.instance}addTimer(e){this.timers.push(e)}clearTimers(){this.timers=new Array}update(e){this.timers.forEach(t=>t.update(e))}}class fe{constructor(){this.particleSystems=new Array}static getInstance(){return fe.instance===null&&(fe.instance=new fe),fe.instance}registerParticleSystem(e){this.particleSystems.push(e)}deregisterParticleSystem(e){let t=this.particleSystems.indexOf(e);this.particleSystems.splice(t,1)}clearParticleSystems(){this.particleSystems=new Array}update(e){for(let t of this.particleSystems)t.update(e)}}fe.instance=null;class Ot{constructor(e,t,i,s){this.sceneOptions=lt.parse(s===void 0?{}:s),this.worldSize=new r(500,500),this.viewport=e,this.viewport.setBounds(0,0,2560,1280),this.running=!1,this.sceneManager=t,this.receiver=new ye,this.emitter=new pe,this.tilemaps=new Array,this.sceneGraph=new Ti(this.viewport,this),this.layers=new L,this.uiLayers=new L,this.parallaxLayers=new L,this.physicsManager=new vi(this.sceneOptions.physics),this.navManager=new ki,this.aiManager=new _i,this.renderingManager=i,this.add=new Di(this,this.tilemaps),this.load=D.getInstance(),this.resourceManager=this.load,De.getInstance().clearTimers()}initScene(e){}loadScene(){}startScene(){}updateScene(e){}unloadScene(){}update(e){this.updateScene(e),De.getInstance().update(e),this.aiManager.update(e),this.physicsManager.update(e),this.sceneGraph.update(e),this.tilemaps.forEach(t=>{t.getLayer().isPaused()||t.update(e)}),he.getInstance().update(e),fe.getInstance().update(e),this.viewport.update(e)}render(){let e=this.sceneGraph.getVisibleSet();this.parallaxLayers.forEach(i=>{let s=this.parallaxLayers.get(i);for(let a of s.getItems())a instanceof Te&&e.push(a)}),this.renderingManager.render(e,this.tilemaps,this.uiLayers);let t=this.sceneGraph.getAllNodes();this.tilemaps.forEach(i=>i.visible?t.push(i):0),F.setNodes(t)}setRunning(e){this.running=e}isRunning(){return this.running}remove(e){e instanceof Te&&this.sceneGraph.removeNode(e)}destroy(){for(let e of this.sceneGraph.getAllNodes())e.destroy();for(let e of this.tilemaps)e.destroy();this.receiver.destroy(),delete this.sceneGraph,delete this.physicsManager,delete this.navManager,delete this.aiManager,delete this.receiver}addLayer(e,t){if(this.layers.has(e)||this.parallaxLayers.has(e)||this.uiLayers.has(e))throw`Layer with name ${e} already exists`;let i=new Ct(this,e);return this.layers.add(e,i),t&&i.setDepth(t),i}addParallaxLayer(e,t,i){if(this.layers.has(e)||this.parallaxLayers.has(e)||this.uiLayers.has(e))throw`Layer with name ${e} already exists`;let s=new Ie(this,e,t);return this.parallaxLayers.add(e,s),i&&s.setDepth(i),s}addUILayer(e){if(this.layers.has(e)||this.parallaxLayers.has(e)||this.uiLayers.has(e))throw`Layer with name ${e} already exists`;let t=new st(this,e);return this.uiLayers.add(e,t),t}getLayer(e){if(this.layers.has(e))return this.layers.get(e);if(this.parallaxLayers.has(e))return this.parallaxLayers.get(e);if(this.uiLayers.has(e))return this.uiLayers.get(e);throw`Requested layer ${e} does not exist.`}isParallaxLayer(e){return this.parallaxLayers.has(e)}isUILayer(e){return this.uiLayers.has(e)}getViewTranslation(e){let t=e.getLayer();return t instanceof Ie||t instanceof st?this.viewport.getOrigin().mult(t.parallax):this.viewport.getOrigin()}getViewScale(){return this.viewport.getZoomLevel()}getViewport(){return this.viewport}getWorldSize(){return this.worldSize}getSceneGraph(){return this.sceneGraph}getPhysicsManager(){return this.physicsManager}getNavigationManager(){return this.navManager}getAIManager(){return this.aiManager}generateId(){return this.sceneManager.generateId()}getTilemap(e){for(let t of this.tilemaps)if(t.name===e)return t;return null}}var j;(function(n){n.Grounded="grounded",n.Ascending="ascending",n.Descending="descending"})(j||(j={}));var P;(function(n){n.Dash="dash",n.Attack="attack",n.AttackUpper="attackUpper",n.AttackDown="attackDown",n.Idle="idle",n.Jump="jump",n.Dead="dead"})(P||(P={}));var M;(function(n){n.Idle="Idle",n.Walk="Walk",n.Up="Up",n.Down="Down",n.Dash="Dash",n.ScytheUpper="Scythe Upper",n.ScytheDown="Scythe Down",n.ScytheSlash="Scythe Slash",n.TakeDamage="Take Damage",n.Dying="Dying",n.Dead="Dead"})(M||(M={}));var _;(function(n){n.Dash="playerDash",n.Hurt="playerHurt",n.Heal="playerHeal",n.Slash="playerSlash",n.Death="playerDeath",n.Jump="playerJump"})(_||(_={}));class He{constructor(){this.stack=new Nt,this.stateMap=new L,this.receiver=new ye,this.emitter=new pe,this.emitEventOnStateChange=!1}subscribe(e){return this.receiver.subscribe(e),this}getState(){return this.currentState}isState(e){return this.stateMap.get(e)==this.currentState}setActive(e){this.active=e}setEmitEventOnStateChange(e){this.emitEventOnStateChange=!0,this.stateChangeEventName=e}cancelEmitEventOnStateChange(){this.emitEventOnStateChange=!1}initialize(e,t){this.stack.push(this.stateMap.get(e)),this.currentState=this.stack.peek(),this.currentState.onEnter(t),this.setActive(!0)}addState(e,t){return this.stateMap.add(e,t),this}changeState(e){let t=this.currentState.onExit();e==="previous"?this.stack.pop():(this.stack.pop(),this.stack.push(this.stateMap.get(e))),this.currentState=this.stack.peek(),this.emitEventOnStateChange&&this.emitter.fireEvent(this.stateChangeEventName,{state:this.currentState}),this.currentState.onEnter(t)}handleEvent(e){this.active&&this.currentState.handleInput(e)}update(e){for(;this.receiver.hasNextEvent();){let t=this.receiver.getNextEvent();this.handleEvent(t)}this.currentState.update(e)}}class we{constructor(e){this.parent=e,this.emitter=new pe}finished(e){this.parent.changeState(e)}}class zt extends we{constructor(e,t,i){super(e),this.owner=t,this.player=i}handleInput(e){}getInputDirection(){const e=r.ZERO;return e.x=(l.isPressed("left")?-1:0)+(l.isPressed("right")?1:0),e.y=l.isJustPressed("jump")?-1:0,e}}class Ut extends zt{update(e){const t=this.getInputDirection();t.x==-1?this.owner.invertX=!0:t.x==1&&(this.owner.invertX=!1),this.player.velocity=this.owner.getLastVelocity(),this.player.velocity.x=t.x*this.player.speed*e}isActionAnimationPlaying(){return[M.ScytheSlash,M.Dash,M.ScytheUpper,M.ScytheDown,M.TakeDamage,M.Dying,M.Dead].some(e=>this.owner.animation.isPlaying(e))}}class Le extends zt{}let Ke=class extends Le{onEnter(e){this.stateName="Idle"}handleInput(e){super.handleInput(e)}onExit(){return{}}update(e){l.isJustPressed(E.Dash)&&this.player.canDash&&this.finished(P.Dash)}};class O{constructor(e,t,i=!1){De.getInstance().addTimer(this),this.totalTime=e,this.timeLeft=0,this.onEnd=t,this.loop=i,this.state=q.STOPPED,this.numRuns=0}isStopped(){return this.state===q.STOPPED}isPaused(){return this.state===q.PAUSED}hasRun(){return this.numRuns>0}start(e){e!==void 0&&(this.totalTime=e),this.state=q.ACTIVE,this.timeLeft=this.totalTime}reset(){this.timeLeft=this.totalTime,this.numRuns=0}pause(){this.state=q.PAUSED}update(e){this.state===q.ACTIVE&&(this.timeLeft-=e*1e3,this.timeLeft<=0&&(this.timeLeft=w.clampLow0(this.timeLeft),this.end()))}end(){this.state=q.STOPPED,this.numRuns+=1,this.onEnd&&this.onEnd(),this.loop&&(this.state=q.ACTIVE,this.timeLeft=this.totalTime)}toString(){return"Timer: "+this.state+" - Time Left: "+this.timeLeft+"ms of "+this.totalTime+"ms"}}var q;(function(n){n.ACTIVE="ACTIVE",n.PAUSED="PAUSED",n.STOPPED="STOPPED"})(q||(q={}));let Bt=class extends Le{onEnter(e){this.stateName="Dashing",this.owner.animation.play(M.Dash),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Dash,loop:!1,holdReference:!1}),this.dashTimer=new O(200,()=>this.finished(P.Idle),!1),this.dashTimer.start()}update(e){this.owner.onGround||(this.player.canDash=!1),this.player.velocity.y=this.player.node.onGround?1e-5:0;const t=this.getInputDirection().x==0?this.owner.invertX?-1:1:this.getInputDirection().x;this.player.speed=500,this.player.velocity.x=t*this.player.speed*e}onExit(){return{state:P.Dash}}};class Ni extends Ut{onEnter(e){this.stateName="Grounded",this.player.canDash=!0}performingAction(){}update(e){super.update(e);const t=this.getInputDirection();this.isActionAnimationPlaying()||(t.x!=0?this.owner.animation.playIfNotAlready(M.Walk,!0):this.owner.animation.playIfNotAlready(M.Idle,!0)),this.player.actionStateMachine.getState()instanceof Bt||(this.player.speed=300),l.isJustPressed(E.Jump)?this.player.actionStateMachine.changeState(P.Jump):this.player.velocity.y=1e-5,l.isJustPressed(E.Attack)&&this.player.actionStateMachine.getState()instanceof Ke&&(l.isPressed(E.Up)?this.player.actionStateMachine.changeState(P.AttackUpper):this.player.actionStateMachine.changeState(P.Attack)),this.owner.onGround||this.finished(j.Descending)}onExit(){return this.player.lastGroundedPosition=this.owner.position.clone().sub(new r(this.getInputDirection().x*40,0)),{}}}class Gt extends Ke{onEnter(e){e&&(this.fromDash=e.state==P.Dash),this.stateName="Jump",this.player.velocity.y=this.player.jumpVelocity,this.player.movementStateMachine.changeState(j.Ascending),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Jump,loop:!1,keepReference:!1})}onExit(){return{}}update(e){super.update(e),l.isPressed(E.Jump)||(this.player.velocity.y<0&&this.player.movementStateMachine.changeState(j.Descending),this.finished(P.Idle))}}class Ft extends Ut{onEnter(e){this.stateName="InAir"}update(e){super.update(e),this.player.velocity.y=Math.min(this.player.gravity*e+this.player.velocity.y,10),l.isJustPressed(E.Attack)&&(this.player.actionStateMachine.getState()instanceof Gt||this.player.actionStateMachine.getState()instanceof Ke)&&(l.isPressed(E.Up)?this.player.actionStateMachine.changeState(P.AttackUpper):l.isPressed(E.Down)?this.player.actionStateMachine.changeState(P.AttackDown):this.player.actionStateMachine.changeState(P.Attack)),this.owner.position.y>1500&&(this.owner.position=new r(this.player.lastGroundedPosition.x,this.player.lastGroundedPosition.y-150)),this.owner.onGround&&this.finished(j.Grounded)}onExit(){return{}}}class Oi extends Ft{onEnter(e){super.onEnter(e),this.stateName="Ascending",this.isActionAnimationPlaying()||this.owner.animation.playIfNotAlready(M.Up)}update(e){super.update(e),this.player.velocity.y>0&&this.finished(j.Descending)}}class zi extends Ft{onEnter(e){super.onEnter(e),this.stateName="Descending",this.player.velocity.y=0,this.isActionAnimationPlaying()||this.owner.animation.playIfNotAlready(M.Down)}update(e){super.update(e),this.player.velocity.y<0&&this.finished(j.Ascending)}}class Ne extends He{initializeAI(e,t){}destroy(){delete this.owner,this.receiver.destroy()}activate(e){}}class Ht extends we{constructor(e,t){super(e),this.owner=t,this.hasHit=!0}update(e){}}var me;(function(n){n.TO_PLAYER="TO_PLAYER",n.TO_ENEMY="TO_ENEMY",n.CONTACT="CONTACT"})(me||(me={}));class Ui extends Ht{onEnter(e){this.stateName=ce.Active,this.owner.animation.play("animation",!1)}update(e){super.update(e);const t=this.owner.getScene().player.node;let i=t.position.x+this.parent.offset.x;const s=t.position.y+this.parent.offset.y;this.parent.invertX&&(i=i-this.parent.offset.x*2,this.owner.invertX=!0),this.owner.position=new r(i,s),this.hasHit&&(this.parent.eventType===me.TO_ENEMY&&this.owner.getScene().enemies.forEach(o=>{this.owner.collisionShape.overlaps(o.node.collisionShape)&&(this.emitter.fireEvent(C.ENEMY_DAMAGE,{enemy:o}),this.hasHit=!1,o.knockback())}),this.parent.eventType===me.TO_PLAYER&&this.owner.collisionShape.overlaps(t.collisionShape)&&(this.emitter.fireEvent(C.PLAYER_DAMAGE),this.hasHit=!1)),this.owner.animation.isPlaying("animation")||this.owner.destroy()}handleInput(e){}onExit(){return{}}}class Bi extends Ht{onEnter(e){this.stateName=ce.Manager}update(e){super.update(e),this.finished(ce.Active)}handleInput(e){}onExit(){return{}}}class Gi extends Ne{constructor(){super(...arguments),this.velocity=r.ZERO}initializeAI(e,t){this.owner=e,this.invertX=t.invertX,this.offset=t.offset,this.eventType=t.eventType,this.owningEntity=t.owner,this.initializeStates()}initializeStates(){this.addState(ce.Active,new Ui(this,this.owner)),this.addState(ce.Manager,new Bi(this,this.owner)),this.initialize(ce.Manager)}update(e){super.update(e)}get state(){return this.stack.peek()}}var ce;(function(n){n.Active="Active",n.Contact="Contact",n.Manager="Manager"})(ce||(ce={}));class dt{constructor(e,t,i,s,a,o,d){this.node=t,this.node.addPhysics(new z(s,a),new r(0,0)),this.node.setGroup(ee.HITBOX_PHYS),this.node.addAI(Gi,{invertX:o,offset:d,eventType:i,owner:e})}}class Fi extends Le{onEnter(e){this.stateName="Attack",this.owner.animation.playIfNotAlready(M.ScytheSlash),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Slash+Math.ceil(Math.random()*3),loop:!1,keepReference:!1});const t=new r(40,0),i=this.player.node.getScene().add.animatedSprite("ScytheSlash",x.Main);new O(100,()=>{new dt(this.player.node,i,me.TO_ENEMY,new r(0,0),new r(52,40),this.player.node.invertX,t)},!1).start()}onExit(){return{}}update(e){this.owner.animation.isPlaying(M.ScytheSlash)||this.player.actionStateMachine.changeState(P.Idle)}}class Hi extends Le{onEnter(e){this.stateName="AttackDown",this.owner.animation.playIfNotAlready(M.ScytheDown,!1),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Slash+Math.ceil(Math.random()*3),loop:!1,keepReference:!1});const t=new r(10,50),i=this.player.node.getScene().add.animatedSprite("ScytheDown",x.Main);new O(120,()=>{new dt(this.player.node,i,me.TO_ENEMY,new r(0,0),new r(30,60),this.player.node.invertX,t)},!1).start()}onExit(){return{}}update(e){this.owner.animation.isPlaying(M.ScytheDown)||this.player.actionStateMachine.changeState(P.Idle)}}class Wi extends Le{onEnter(e){this.stateName="AttackUpper",this.owner.animation.playIfNotAlready(M.ScytheUpper),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Slash+Math.ceil(Math.random()*3),loop:!1,keepReference:!1});const t=new r(10,-50),i=this.player.node.getScene().add.animatedSprite("ScytheUpper",x.Main);new O(120,()=>{new dt(this.player.node,i,me.TO_ENEMY,new r(0,0),new r(30,60),this.player.node.invertX,t)},!1).start()}onExit(){return{}}update(e){this.owner.animation.isPlaying(M.ScytheUpper)||this.player.actionStateMachine.changeState(P.Idle)}}class Yi extends Le{onEnter(e){this.stateName="Dead",this.player.node.animation.play(M.Dying),this.player.node.animation.queue(M.Dead,!0),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Death,loop:!1,keepReference:!1})}handleInput(e){super.handleInput(e)}onExit(){return{}}update(e){}}class ji{constructor(e){this.velocity=new r,this.speed=300,this.timeToApex=.35,this.jumpHeight=20,this.node=e,this.node.addPhysics(new z(new r(0,0),wt.PLAYER)),this.node.setGroup(ee.PLAYER_PHYS),this.node.position=new r(100,50),this.node.animation.play(M.Idle,!0),this.maxHealth=10,this.health=10,this.emitter=new pe,this.updateGravity(),this.initializeAI()}changeHealth(e){if(this.health<=0)return;e<0?(this.node.animation.play(M.TakeDamage),this.emitter.fireEvent(p.PLAY_SFX,{key:_.Hurt,loop:!1,holdReference:!1})):e>0&&this.health!=this.maxHealth&&this.emitter.fireEvent(p.PLAY_SFX,{key:_.Heal,loop:!1,holdReference:!1});const t=this.health+e;this.health=w.clamp(t,0,this.maxHealth),t<=0&&(this.actionStateMachine.changeState(P.Dead),this.emitter.fireEvent(C.PLAYER_DEATH))}updateGravity(){this.gravity=2*this.jumpHeight/Math.pow(this.timeToApex,2)/10,this.jumpVelocity=-this.gravity*this.timeToApex}update(e){this.movementStateMachine.update(e),this.actionStateMachine.update(e),this.node.move(this.velocity)}initializeAI(){this.movementStateMachine=new He,this.movementStateMachine.addState(j.Grounded,new Ni(this.movementStateMachine,this.node,this)).addState(j.Ascending,new Oi(this.movementStateMachine,this.node,this)).addState(j.Descending,new zi(this.movementStateMachine,this.node,this)).initialize(j.Grounded),this.actionStateMachine=new He,this.actionStateMachine.addState(P.Dash,new Bt(this.actionStateMachine,this.node,this)).addState(P.Idle,new Ke(this.actionStateMachine,this.node,this)).addState(P.Jump,new Gt(this.actionStateMachine,this.node,this)).addState(P.Attack,new Fi(this.actionStateMachine,this.node,this)).addState(P.AttackUpper,new Wi(this.actionStateMachine,this.node,this)).addState(P.AttackDown,new Hi(this.actionStateMachine,this.node,this)).addState(P.Dead,new Yi(this.actionStateMachine,this.node,this)).initialize(P.Idle)}}class Vi{constructor(e,t){this.node=e,this.offset=t}update(e){const t=this.following.position.clone().add(this.offset);Math.abs(this.node.position.y-this.following.position.clone().y)>Math.abs(this.offset.y)&&(this.node.position.y=w.lerp(this.node.position.y,t.y,3*e)),this.node.position.x=t.x}follow(e){this.following=e}}class qe extends we{constructor(e,t){super(e),this.owner=t,this.followingCDTimer=new O(1e4),this.stuckTimer=new O(5e3),this.contactCooldown=new O(1e3),this.knockbackTimer=new O(500),this.isDying=!1}handleInput(e){}withinXBlock(e){return this.playerPos=this.owner.getScene().player.node.position,Math.abs(this.owner.position.x-this.playerPos.x)<=32*e&&Math.abs(this.owner.position.y-this.playerPos.y)<=32*e}update(e){this.owner.onWall&&(this.parent.direction.x*=-1,this.owner.invertX=!this.owner.invertX),this.contactCooldown.isStopped()&&!this.isDying&&this.owner.collisionShape.overlaps(this.owner.getScene().player.node.collisionShape)&&(this.emitter.fireEvent(C.PLAYER_DAMAGE),this.contactCooldown.start()),(this.owner.onCeiling||this.owner.onGround)&&(this.parent.direction.y*=-1)}}class Qi extends qe{onEnter(e){this.parent.direction=this.parent.randomDirection(),this.stateName="Drifting",this.canFollow=!1}update(e){super.update(e),this.withinXBlock(10)&&(this.canFollow=!0),this.canFollow?this.finished(B.Following):(this.parent.velocity.x=this.parent.direction.x*this.parent.driftSpeed*e,this.parent.velocity.y=this.parent.direction.y*this.parent.driftSpeed*e,this.owner.move(this.parent.velocity))}onExit(){return{}}}let Xi=class extends qe{onEnter(e){this.stateName="Following",this.stuckTimer.start(),this.canFollow=!0}update(e){if(super.update(e),this.withinXBlock(6)||(this.canFollow=!1),this.canFollow)if(this.owner.onWall||this.owner.onCeiling||this.owner.onGround){if(this.stuckTimer.isStopped()){this.followingCDTimer.start(),this.finished(B.Drifting);return}}else this.stuckTimer.reset();else{this.followingCDTimer.start(),this.finished(B.Drifting);return}this.parent.direction=this.owner.position.dirTo(this.playerPos),this.parent.velocity.x=this.parent.direction.x*this.parent.followSpeed*e,this.parent.velocity.y=this.parent.direction.y*this.parent.followSpeed*e,this.owner.move(this.parent.velocity)}onExit(){return{}}},Ki=class extends qe{onEnter(e){this.playerPos=this.owner.getScene().player.node.position,this.parent.direction.x=this.owner.position.x-this.playerPos.x>0?1:-1,this.parent.direction.y=0,this.stateName=B.Knockback,this.knockbackTimer.start()}update(e){super.update(e),this.parent.velocity.x=this.parent.direction.x*this.parent.knockbackSpeed*e,this.parent.velocity.y=this.parent.direction.y*this.parent.knockbackSpeed*e,this.owner.move(this.parent.velocity),this.knockbackTimer.isStopped()&&(this.withinXBlock(6)?this.canFollow=!0:this.canFollow=!1,this.canFollow?this.finished(B.Following):this.finished(B.Drifting))}onExit(){return{}}},qi=class extends qe{onEnter(e){this.owner.animation.play(ve.Dying),this.owner.animation.queue(ve.Dead,!0),this.parent.velocity=r.ZERO}update(e){this.isDying=!0,super.update(e),this.owner.animation.isPlaying(ve.Dying)||this.owner.destroy()}onExit(){return{}}};var B;(function(n){n.Drifting="drifting",n.Following="following",n.Knockback="knockback",n.Dying="dying"})(B||(B={}));let Zi=class extends Ne{constructor(){super(...arguments),this.direction=r.ZERO,this.velocity=r.ZERO,this.driftSpeed=10,this.followSpeed=30,this.knockbackSpeed=150,this.gravity=0}initializeAI(e,t){this.owner=e,this.direction=this.randomDirection(),this.initializeStates()}initializeStates(){this.addState(B.Drifting,new Qi(this,this.owner)),this.addState(B.Following,new Xi(this,this.owner)),this.addState(B.Knockback,new Ki(this,this.owner)),this.addState(B.Dying,new qi(this,this.owner)),this.initialize(B.Drifting)}update(e){super.update(e),this.owner&&this.owner.move(this.velocity)}randomDirection(){return r.UP.rotateCCW(Math.random()*Math.PI*2)}get state(){return this.stack.peek()}};class Oe{constructor(){this.isInvincible=!1}die(){}takeDamage(){}knockback(){}}var Ae;(function(n){n.RED="red",n.BLUE="blue"})(Ae||(Ae={}));var ve;(function(n){n.Idle="Idle",n.Dying="Dying",n.Dead="Dead"})(ve||(ve={}));class Ze extends Oe{constructor(e,t,i){super(),this.node=e,this.node.scale=new r(.5,.5),this.node.addPhysics(new z(new r(0,0),wt.SOUL),new r(0,0)),this.node.addAI(Zi),this.node.setGroup(ee.ENEMY_PHYS),this.node.position=t,this.node.animation.play(ve.Idle,!0),this.health=1,this.type=i}die(){this.node._ai.changeState(B.Dying)}knockback(){this.node._ai.changeState(B.Knockback)}}var x;(function(n){n.Main="main",n.UI="ui",n.Background="bg",n.Parallax="parallax",n.Hidden="hidden",n.Debug="debg",n.Pause="pause",n.DeathMenu="death"})(x||(x={}));class Pe extends Ot{constructor(e,t,i,s){super(e,t,i,s),this.playerInvincible=!1,this.textColor=new g(231,224,241),this.healthBarColor=new g(215,74,91),this.enemies=new Array}loadScene(){this.load.spritesheet("reaper","assets/spritesheets/Reaper/reaper.json"),this.load.spritesheet("ScytheSlash","assets/spritesheets/Reaper/ReaperVFX/ScytheSlash.json"),this.load.spritesheet("ScytheUpper","assets/spritesheets/Reaper/ReaperVFX/ScytheUpper.json"),this.load.spritesheet("ScytheDown","assets/spritesheets/Reaper/ReaperVFX/ScytheDown.json"),this.load.audio(_.Dash,"assets/sounds/Player/dash.wav"),this.load.audio(_.Hurt,"assets/sounds/Player/hurt.wav"),this.load.audio(_.Heal,"assets/sounds/Player/heal.wav"),this.load.audio(_.Slash+"1","assets/sounds/Player/slash1.wav"),this.load.audio(_.Slash+"2","assets/sounds/Player/slash2.wav"),this.load.audio(_.Slash+"3","assets/sounds/Player/slash3.wav"),this.load.audio(_.Death,"assets/sounds/Player/death.wav"),this.load.audio(_.Jump,"assets/sounds/Player/jump.wav"),this.load.spritesheet("RedSoul","assets/spritesheets/RedSoul/RedSoul.json"),this.addLayer(x.Main,1),this.addUILayer(x.UI),this.addUILayer(x.Pause).setHidden(!0),this.addUILayer(x.DeathMenu).setHidden(!0),this.addLayer(x.Debug,2),this.addParallaxLayer(x.Parallax,new r(.005,.01),-1),this.addLayer(x.Hidden,1).setHidden(!0)}unloadScene(){this.resourceManager.keepSpritesheet("reaper")}startScene(){this.player=new ji(this.add.animatedSprite("reaper",x.Main)),this.camera=new Vi(this.add.graphic(le.POINT,x.Hidden,{position:this.player.node.position.clone()}),new r(0,0)),this.camera.follow(this.player.node),this.playerStateLabel=this.add.uiElement(N.LABEL,x.Debug,{position:this.player.node.position.clone(),text:""}),this.playerStateLabel.font="Mister Pixel",this.playerStateLabel.textColor=g.WHITE,this.playerActionStateLabel=this.add.uiElement(N.LABEL,x.Debug,{position:this.player.node.position.clone(),text:""}),this.playerActionStateLabel.font="Mister Pixel",this.playerActionStateLabel.textColor=g.WHITE,this.viewport.follow(this.camera.node),this.viewport.setZoomLevel(2),this.viewport.setSmoothingFactor(0),this.initPauseLayer(),this.initDeathLayer(),this.initUI(),this.receiver.subscribe(C.ENEMY_DAMAGE),this.receiver.subscribe(C.PLAYER_DAMAGE),this.receiver.subscribe(C.ENEMY_DEATH),this.receiver.subscribe(C.PLAYER_DEATH),this.receiver.subscribe(C.PLAYER_HEAL),this.receiver.subscribe(C.LEVEL_END),this.receiver.subscribe(C.ENTER_LEVEL_END)}update(e){for(l.isJustPressed(E.Pause)&&(l.disableInput(),this.uiLayers.get(x.Pause).setHidden(!1)),this.handleCheats(),this.camera.update(e),this.player.update(e),super.update(e),this.playerStateLabel.text=this.player.movementStateMachine.getState().stateName,this.playerStateLabel.position=this.player.node.position.clone().add(new r(0,-40)),this.playerActionStateLabel.text=this.player.actionStateMachine.getState().stateName,this.playerActionStateLabel.position=this.player.node.position.clone().add(new r(0,-80));this.receiver.hasNextEvent();)this.handleEvent(this.receiver.getNextEvent())}handleEvent(e){switch(e.type){case C.ENEMY_DAMAGE:{const t=e.data.get("enemy");t.isInvincible||(t.health-=1,console.log(`Enemy: ${t.health}`),t.takeDamage(),t.health<=0&&this.emitter.fireEvent(C.ENEMY_DEATH,{enemy:t}));break}case C.PLAYER_DAMAGE:{this.playerInvincible?console.log("Player is invincible!"):(this.player.changeHealth(-1),this.healthBar.size.x=600*(this.player.health/10),this.healthBar.position.x=0,console.log(`Player: ${this.player.health}`));break}case C.PLAYER_HEAL:{this.player.changeHealth(1),this.healthBar.size.x=600*(this.player.health/10),this.healthBar.position.x=0,console.log(`Player: ${this.player.health}`);break}case C.ENEMY_DEATH:{const t=e.data.get("enemy");t.type===Ae.RED&&this.emitter.fireEvent(C.PLAYER_HEAL),t.die(),this.enemies=this.enemies.filter(i=>i!==t);break}case C.PLAYER_DEATH:{l.disableInput(),this.uiLayers.get(x.DeathMenu).setHidden(!1);break}case C.LEVEL_END:{this.sceneManager.changeToScene(this.nextLevel,{},G);break}case C.ENTER_LEVEL_END:{this.enemies.length===0&&this.emitter.fireEvent(C.LEVEL_END);break}}}initUI(){this.healthBar=this.add.uiElement(N.LABEL,x.UI,{position:new r(0,30),text:""}),this.healthBar.size=new r(600,50),this.healthBar.backgroundColor=this.healthBarColor,this.healthBar.borderWidth=2,this.healthBar.borderRadius=0;const e=this.add.uiElement(N.LABEL,x.UI,{position:new r(70,30),text:""});e.size=new r(320,50),e.borderColor=g.WHITE,e.borderWidth=2,e.borderRadius=0}initPauseLayer(){const i=this.newButton(new r(100,70),"RESUME",52,x.Pause);i.size.x=450,i.size.y=65,i.onClick=()=>{l.enableInput(),this.uiLayers.get(x.Pause).setHidden(!0)};const s=this.newButton(new r(100,108),"MENU",52,x.Pause);s.onClick=()=>{l.enableInput(),this.sceneManager.changeToScene(rt)},s.size.x=450,s.size.y=65}initDeathLayer(){const i=this.newButton(new r(300,200),"RETURN TO MENU",52,x.DeathMenu);i.onClick=()=>{l.enableInput(),this.sceneManager.changeToScene(rt)},i.size.x=500,i.size.y=80}handleHealthChange(e,t){console.log(e);const i=this.healthBarBg.size.x/t;this.healthBar.size.set(this.healthBarBg.size.x-i*(t-e),this.healthBarBg.size.y),this.healthBar.position.set(this.healthBarBg.position.x-i/2/this.getViewScale()*(t-e),this.healthBarBg.position.y)}addLevelEnd(e,t){this.levelEndArea=this.add.graphic(le.RECT,x.Main,{position:e,size:t}),this.levelEndArea.addPhysics(void 0,void 0,!1,!0),this.levelEndArea.setTrigger(ee.PLAYER_PHYS,C.ENTER_LEVEL_END,null),this.levelEndArea.color=new g(255,255,255,1)}newButton(e,t,i,s){const a=this.add.uiElement(N.BUTTON,s,{position:e,text:t});return a.borderColor=g.WHITE,a.borderWidth=2,a.borderRadius=0,a.setPadding(new r(50,10)),a.font="MEGAPIX",a.fontSize=i,a.textColor=this.textColor,a.backgroundColor=new g(16,14,18,1),a.scale.set(1/this.viewport.getZoomLevel(),1/this.viewport.getZoomLevel()),a}handleCheats(){l.isJustPressed(E.Invincible)&&(this.playerInvincible=!this.playerInvincible,this.playerInvincible&&console.log("Player is now invincible.")),l.isJustPressed(E.Invincible)&&(this.playerInvincible=!this.playerInvincible),l.isJustPressed(E.Invincible)&&(this.playerInvincible=!this.playerInvincible),l.isJustPressed(E.Level1)&&this.sceneManager.changeToScene(xe.Level1,{},G),l.isJustPressed(E.Level2)&&this.sceneManager.changeToScene(xe.Level2,{},G),l.isJustPressed(E.Level3)&&this.sceneManager.changeToScene(xe.Level3,{},G),l.isJustPressed(E.Level4)&&this.sceneManager.changeToScene(xe.Level4,{},G),l.isJustPressed(E.Level5)&&this.sceneManager.changeToScene(xe.Level5,{},G),l.isJustPressed(E.Level6)&&this.sceneManager.changeToScene(xe.Level6,{},G)}}class ct extends Pe{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/Debug/Level1.json"),this.load.audio("bluddington","assets/music/bluddington.mp3")}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}startScene(){super.startScene(),this.player.node.position=new r(100,1e3),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,6400,1280),this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0})}}class ut extends we{constructor(e,t){super(e),this.owner=t,this.contactCooldown=new O(1e3),this.knockbackTimer=new O(500),this.idleTimer=new O(4e3),this.isDying=!1}handleInput(e){}withinXBlock(e){return this.playerPos=this.owner.getScene().player.node.position,Math.abs(this.owner.position.x-this.playerPos.x)<=32*e&&Math.abs(this.owner.position.y-this.playerPos.y)<=32*e}onCliffRight(){let e=new r(this.owner.position.x+this.owner.sizeWithZoom.x/2+1,this.owner.position.y+this.owner.sizeWithZoom.y/2+1);return this.parent.tilemap.getTileAtWorldPosition(e)===0}onCliffLeft(){let e=new r(this.owner.position.x-this.owner.size.x/2-1,this.owner.position.y+this.owner.size.y/2+1);return this.parent.tilemap.getTileAtWorldPosition(e)===0}update(e){this.contactCooldown.isStopped()&&!this.isDying&&this.owner.collisionShape.overlaps(this.owner.getScene().player.node.collisionShape)&&(this.emitter.fireEvent(C.PLAYER_DAMAGE),this.contactCooldown.start())}}let $i=class extends ut{onEnter(e){this.owner.animation.play(ue.Dying),this.owner.animation.queue(ue.Dead,!0),this.parent.velocity=r.ZERO}update(e){this.isDying=!0,super.update(e),this.owner.animation.isPlaying(ue.Dying)||this.owner.destroy()}onExit(){return{}}};class Pt extends ut{onEnter(e){this.parent.direction.x*=-1,this.owner.invertX=!this.owner.invertX,this.owner.animation.playIfNotAlready(ue.Walking,!0),this.justEnter=!0}update(e){if(super.update(e),this.parent.velocity.x=this.parent.direction.x*this.parent.speed*e,this.parent.velocity.y=this.parent.gravity*e,this.parent.direction.x===1){if(this.onCliffRight()||this.owner.onWall){this.finished(Q.Idle);return}}else if(this.parent.direction.x===-1&&(this.onCliffLeft()||this.owner.onWall)){this.finished(Q.Idle);return}this.owner.move(this.parent.velocity)}onExit(){return{}}}class Ji extends ut{onEnter(e){this.stateName="Idle",this.owner.animation.playIfNotAlready(ue.Idle,!0),this.idleTimer.start(),console.log("Idle"),console.log("size: "+this.owner.size)}update(e){super.update(e),this.idleTimer.isStopped()&&this.owner.onGround&&this.finished(Q.Walking),this.parent.velocity.x=0,this.parent.velocity.y=this.parent.gravity*e,this.owner.move(this.parent.velocity)}onExit(){return{}}}var Q;(function(n){n.Idle="Idle",n.Walking="Walking",n.Dying="Dying",n.Knockback="Knockback",n.Attacking="Attacking"})(Q||(Q={}));class es extends Ne{constructor(){super(...arguments),this.direction=r.RIGHT,this.velocity=r.ZERO,this.speed=20,this.knockbackSpeed=25,this.gravity=10}initializeAI(e,t){this.owner=e,this.tilemap=t.tilemap,this.initializeStates()}initializeStates(){this.addState(Q.Idle,new Ji(this,this.owner)),this.addState(Q.Walking,new Pt(this,this.owner)),this.addState(Q.Attacking,new Pt(this,this.owner)),this.addState(Q.Dying,new $i(this,this.owner)),this.initialize(Q.Idle)}update(e){super.update(e)}randomDirection(){return r.UP.rotateCCW(Math.random()*Math.PI*2)}get state(){return this.stack.peek()}}var ue;(function(n){n.Idle="Idle",n.Dying="Dying",n.Dead="Dead",n.Attacking="Attacking",n.Walking="Walking"})(ue||(ue={}));class ts extends Oe{constructor(e,t,i){super(),this.node=e,this.tilemap=this.node.getScene().getTilemap(i),this.node.addPhysics(new z(new r(0,0),wt.ZOMBIE),new r(0,0)),this.node.addAI(es,{tilemap:this.tilemap}),this.node.setGroup(ee.ENEMY_PHYS),this.node.position=t,this.node.animation.play(ue.Idle,!0),this.health=3}die(){this.node._ai.changeState(Q.Dying)}knockback(){}}class gt extends Pe{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/Debug/Level1.json"),this.load.spritesheet("Zombie","assets/spritesheets/Zombie/Zombie.json"),this.load.audio("bluddington","assets/music/bluddington.mp3")}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}startScene(){super.startScene(),this.player.node.position=new r(100,1e3),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,6400,1280),this.nextLevel=ct,this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0}),this.addLevelEnd(new r(4576,128),new r(32,135)),this.initializeZombies()}initializeZombies(){const e=[new r(1236,1044),new r(2240,692),new r(3840,604)];for(let t=0;t<3;t++){const i=new ts(this.add.animatedSprite("Zombie",x.Main),new r(e[t].x,e[t].y),"World");this.enemies.push(i)}}}class pt extends we{constructor(e,t,i,s){super(e),this.enemiesAlive=t,this.waveInfo=i,this.level=s,this.waveCD=new O(2e3)}}class is extends pt{onEnter(e){this.waveCD.start()}handleInput(e){}update(e){this.waveCD.isStopped()&&this.level.currentWave<this.waveInfo.length&&this.finished(J.SPAWNING)}onExit(){return{}}}const ss=[151,160,137,91,90,15,131,13,201,95,96,53,194,233,7,225,140,36,103,30,69,142,8,99,37,240,21,10,23,190,6,148,247,120,234,75,0,26,197,62,94,252,219,203,117,35,11,32,57,177,33,88,237,149,56,87,174,20,125,136,171,168,68,175,74,165,71,134,139,48,27,166,77,146,158,231,83,111,229,122,60,211,133,230,220,105,92,41,55,46,245,40,244,102,143,54,65,25,63,161,1,216,80,73,209,76,132,187,208,89,18,169,200,196,135,130,116,188,159,86,164,100,109,198,173,186,3,64,52,217,226,250,124,123,5,202,38,147,118,126,255,82,85,212,207,206,59,227,47,16,58,17,182,189,28,42,223,183,170,213,119,248,152,2,44,154,163,70,221,153,101,155,167,43,172,9,129,22,39,253,19,98,108,110,79,113,224,232,178,185,112,104,218,246,97,228,251,34,242,193,238,210,144,12,191,179,162,241,81,51,145,235,249,14,239,107,49,192,214,31,181,199,106,157,184,84,204,176,115,121,50,45,127,4,150,254,138,236,205,93,222,114,67,29,24,72,243,141,128,195,78,66,215,61,156,180];class ns{constructor(){this.p=new Int16Array(512);for(let e=0;e<512;e++)this.p[e]=ss[e%256];this.repeat=-1}perlin(e,t,i=0){this.repeat>0&&(e=e%this.repeat,t=t%this.repeat,i=i%this.repeat);let s=Math.floor(e)&255,a=Math.floor(t)&255,o=Math.floor(i)&255,d=e-Math.floor(e),h=t-Math.floor(t),c=i-Math.floor(i),u=this.fade(d),y=this.fade(h),m=this.fade(c),f=this.p[this.p[this.p[s]+a]+o],A=this.p[this.p[this.p[s]+this.inc(a)]+o],T=this.p[this.p[this.p[s]+a]+this.inc(o)],S=this.p[this.p[this.p[s]+this.inc(a)]+this.inc(o)],W=this.p[this.p[this.p[this.inc(s)]+a]+o],K=this.p[this.p[this.p[this.inc(s)]+this.inc(a)]+o],se=this.p[this.p[this.p[this.inc(s)]+a]+this.inc(o)],ne=this.p[this.p[this.p[this.inc(s)]+this.inc(a)]+this.inc(o)],Y=w.lerp(this.grad(f,d,h,c),this.grad(W,d-1,h,c),u),V=w.lerp(this.grad(A,d,h-1,c),this.grad(K,d-1,h-1,c),u),R=w.lerp(Y,V,y);Y=w.lerp(this.grad(T,d,h,c-1),this.grad(se,d-1,h,c-1),u),V=w.lerp(this.grad(S,d,h-1,c-1),this.grad(ne,d-1,h-1,c-1),u);let b=w.lerp(Y,V,y);return(w.lerp(R,b,m)+1)/2}grad(e,t,i,s){switch(e&15){case 0:return t+i;case 1:return-t+i;case 2:return t-i;case 3:return-t-i;case 4:return t+s;case 5:return-t+s;case 6:return t-s;case 7:return-t-s;case 8:return i+s;case 9:return-i+s;case 10:return i-s;case 11:return-i-s;case 12:return i+t;case 13:return-i+s;case 14:return i-t;case 15:return-i-s;default:return 0}}inc(e){return e++,this.repeat>0&&(e%=this.repeat),e}fade(e){return e*e*e*(e*(e*6-15)+10)}}class as{constructor(){this.p=new ns}perlin(e,t,i){return this.p.perlin(e,t,i)}}class de{static randInt(e,t){return Math.floor(Math.random()*(t-e)+e)}static randFloat(e,t){return Math.random()*(t-e)+e}static randHex(e,t){return w.toHex(de.randInt(e,t))}static randColor(){let e=de.randInt(0,256),t=de.randInt(0,256),i=de.randInt(0,256);return new g(e,t,i)}static randVec(e,t,i,s){return new r(this.randFloat(e,t),this.randFloat(i,s))}}de.noise=new as;class rs extends pt{onEnter(e){this.spawnCD=new O(1e3/this.waveInfo[this.level.currentWave].spawnRate),this.curWaveInfo=this.waveInfo[this.level.currentWave],this.enemyOp=Object.keys(this.curWaveInfo.enemyRemain)}handleInput(e){}update(e){if(this.curWaveInfo.totalRemain===0){this.finished(J.WAITING);return}if(this.spawnCD.isStopped){let t=this.enemyOp[Math.floor(Math.random()*this.enemyOp.length)];for(;this.curWaveInfo.enemyRemain[t]===0;)t=this.enemyOp[Math.floor(Math.random()*this.enemyOp.length)];let i=this.level.tilemap.size,s=de.randVec(0,i.x,0,i.y);for(;s.distanceTo(this.level.player.node.position)<32*6||this.level.tilemap.getTileAtWorldPosition(s)!==0;)s=de.randVec(0,i.x,0,i.y);switch(t){case"ghost_red":this.curWaveInfo.enemyRemain.ghost_red-=1,this.curWaveInfo.totalRemain-=1,this.level.addGhost(s,Ae.RED);break}this.spawnCD.start()}}onExit(){return{}}}class os extends pt{onEnter(e){}handleInput(e){}update(e){if(this.level.enemies.length===0)if(this.level.nextWave(),this.level.currentWave<this.waveInfo.length){this.level.waveLabel.text="Wave: "+[this.level.currentWave+1]+"/"+this.waveInfo.length,this.finished(J.COOLDOWN);return}else{this.level.displayLevelEnd(),this.level.waveLabel.text="Wave: Finished",this.finished(J.COOLDOWN);return}}onExit(){return{}}}var J;(function(n){n.SPAWNING="spawning",n.WAITING="waiting",n.COOLDOWN="cooldown"})(J||(J={}));class hs extends Pe{constructor(){super(...arguments),this.waves=[],this.curWave=0}startWave(){this.initWaveUI(),this.initWaveState()}initWaveUI(){this.waveLabel=this.add.uiElement(N.LABEL,x.UI,{position:new r(500,30),text:"Wave: "+[this.curWave+1]+"/"+this.waves.length}),this.waveLabel.textColor=g.WHITE}initWaveState(){this.waveStateMachine=new He,this.waveStateMachine.addState(J.COOLDOWN,new is(this.waveStateMachine,this.enemies,this.waves,this)).addState(J.SPAWNING,new rs(this.waveStateMachine,this.enemies,this.waves,this)).addState(J.WAITING,new os(this.waveStateMachine,this.enemies,this.waves,this)).initialize(J.COOLDOWN)}update(e){super.update(e),this.waveStateMachine.update(e)}get currentWave(){return this.curWave}set setTilemap(e){this.tilemap=e}nextWave(){this.curWave+=1}setLevelEndArea(e,t){this.LevelEndPos=e,this.LevelEndSize=t}displayLevelEnd(){this.addLevelEnd(this.LevelEndPos,this.LevelEndSize)}addGhost(e,t){const i=new Ze(this.add.animatedSprite("RedSoul",x.Main),new r(e.x,e.y),t);this.enemies.push(i)}}class it{constructor(e){this.totalCount=0,this.enemyCount={[Ue.GHOST_RED]:0},this.enemyRemain={[Ue.GHOST_RED]:0},this.enemyCount[Ue.GHOST_RED]=e[0],this.enemyRemain[Ue.GHOST_RED]=e[0];for(let t of e)this.totalCount+=t;this.totalRemain=this.totalCount}}class ft extends hs{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/WaveTest(Level4)/Level4.json"),this.load.audio("bluddington","assets/music/bluddington.mp3")}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}startScene(){super.startScene(),this.player.node.position=new r(100,1e3),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,6400,1280),this.nextLevel=gt,this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0}),this.setLevelEndArea(new r(2877,670),new r(32,128));let e=this.getTilemap("World");this.setTilemap=e,this.waves=[new it([3]),new it([9]),new it([27])],this.startWave()}}class Wt extends we{constructor(e,t,i){super(e),this.owner=t,this.boss=i}handleInput(e){}update(e){}}class ls extends Wt{onEnter(e){this.stateName="Cocooned",this.owner.animation.play(ge.Cocooned,!0),this.boss.isInvincible=!0}update(e){super.update(e)}onExit(){return{}}}let ds=class extends Wt{onEnter(e){this.owner.animation.play(ge.Dying),this.owner.animation.queue(ge.Dead,!0)}update(e){super.update(e),this.owner.animation.isPlaying(ge.Dying)||this.owner.destroy()}onExit(){return{}}};var Ee;(function(n){n.Cocooned="Cocooned",n.Enraged="Enraged",n.Dying="Dying"})(Ee||(Ee={}));class cs extends Ne{constructor(){super(...arguments),this.gravity=0}initializeAI(e,t){this.owner=e,this.boss=t.boss,this.initializeStates()}initializeStates(){this.addState(Ee.Cocooned,new ls(this,this.owner,this.boss)),this.addState(Ee.Dying,new ds(this,this.owner,this.boss)),this.initialize(Ee.Cocooned)}update(e){super.update(e)}get state(){return this.stack.peek()}}var ge;(function(n){n.Cocooned="Idle Cocooned",n.Exposed="Exposed Idle",n.TakeDamage="Take Damage",n.Dying="Dying",n.Dead="Dead"})(ge||(ge={}));class us extends Oe{constructor(e,t){super(),this.node=e,this.node.addPhysics(new z(new r(0,0),new r(90,55)),new r(0,0)),this.node.addAI(cs,{boss:this}),this.node.setGroup(ee.ENEMY_PHYS),this.node.position=t,this.node.animation.play(ge.Cocooned,!0),this.health=10}takeDamage(){this.node.animation.play(ge.TakeDamage)}die(){this.node._ai.changeState(Ee.Dying)}}class $e extends we{constructor(e,t){super(e),this.owner=t,this.contactCooldown=new O(1e3),this.knockbackTimer=new O(400)}handleInput(e){}withinXBlock(e){return this.playerPos=this.owner.getScene().player.node.position,Math.abs(this.owner.position.x-this.playerPos.x)<=32*e&&Math.abs(this.owner.position.y-this.playerPos.y)<=32*e}angleToPlayer(){this.playerPos=this.owner.getScene().player.node.position;const e=this.playerPos.x-this.owner.position.x,t=this.playerPos.y-this.owner.position.y;return-Math.atan2(t,e)+.5*Math.PI}update(e){this.contactCooldown.isStopped()&&!this.isDying&&this.owner.collisionShape.overlaps(this.owner.getScene().player.node.collisionShape)&&(this.emitter.fireEvent(C.PLAYER_DAMAGE),this.contactCooldown.start()),this.owner.animation.isPlaying(be.Dead)&&this.owner.destroy()}}class gs extends $e{onEnter(e){this.stateName="Following"}update(e){super.update(e),this.withinXBlock(4)&&!this.isDying?this.finished(H.Dashing):this.playerPos&&(this.parent.direction=this.owner.position.dirTo(this.playerPos),this.parent.velocity.x=this.parent.direction.x*this.parent.followSpeed*e,this.parent.velocity.y=this.parent.direction.y*this.parent.followSpeed*e),this.owner.move(this.parent.velocity),this.owner.rotation=this.angleToPlayer()}onExit(){return{}}}class ps extends $e{onEnter(e){this.playerPos=this.owner.getScene().player.node.position,this.parent.direction.x=this.owner.position.x-this.playerPos.x>0?1:-1,this.parent.direction.y=0,this.stateName=H.Knockback,this.knockbackTimer.start()}update(e){super.update(e),this.parent.velocity.x=this.parent.direction.x*this.parent.knockbackSpeed*e,this.parent.velocity.y=this.parent.direction.y*this.parent.knockbackSpeed*e,this.owner.move(this.parent.velocity),this.knockbackTimer.isStopped()&&!this.isDying&&this.finished(H.Following)}onExit(){return{}}}class fs extends $e{onEnter(e){this.owner.animation.playIfNotAlready(be.Dying),this.owner.animation.queue(be.Dead,!0),this.parent.velocity=r.ZERO,this.isDying=!0,this.contactCooldown=new O(1e4),this.contactCooldown.start()}update(e){super.update(e)}onExit(){return{}}}class ms extends $e{constructor(){super(...arguments),this.dashSpeed=380}onEnter(e){this.dashTimer=new O(300,()=>{this.isDying||this.finished(H.Following)},!1),this.pauseTimer=new O(1200,()=>{this.dashTimer.start(),this.isDashing=!0},!1),this.pauseTimer.start(),this.isDashing=!1,this.playerPosSnapshot=this.owner.getScene().player.node.position}update(e){if(this.isDashing){const t=new r(this.playerPosSnapshot.x-this.owner.position.x,this.playerPosSnapshot.y-this.owner.position.y).normalize();this.parent.velocity=t.scale(this.dashSpeed*e)}else this.parent.velocity=r.ZERO;this.owner.rotation=this.angleToPlayer()}onExit(){return{}}}var H;(function(n){n.Following="following",n.Knockback="knockback",n.Dying="dying",n.Dashing="dashing"})(H||(H={}));class ys extends Ne{constructor(){super(...arguments),this.direction=r.ZERO,this.velocity=r.ZERO,this.followSpeed=150,this.knockbackSpeed=250,this.gravity=0}initializeAI(e,t){this.owner=e,this.initializeStates()}initializeStates(){this.addState(H.Knockback,new ps(this,this.owner)),this.addState(H.Dying,new fs(this,this.owner)),this.addState(H.Following,new gs(this,this.owner)),this.addState(H.Dashing,new ms(this,this.owner)),this.initialize(H.Following)}update(e){super.update(e),this.owner&&this.owner.move(this.velocity)}get state(){return this.stack.peek()}}var be;(function(n){n.Idle="Idle",n.Walking="Walking",n.Dying="Dying",n.Dead="Dead"})(be||(be={}));class Yt extends Oe{constructor(e,t){super(),this.node=e,this.node.addPhysics(new z(new r(0,0),new r(20,24)),new r(0,0)),this.node.addAI(ys),this.node.setGroup(ee.ENEMY_PHYS),this.node.position=t,this.node.animation.play(be.Idle,!0),this.health=4}die(){this.node._ai.changeState(H.Dying)}knockback(){this.node._ai.changeState(H.Knockback)}}class mt extends Pe{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/Level3/Level3.json"),this.load.spritesheet("RedSoul","assets/spritesheets/RedSoul/RedSoul.json"),this.load.spritesheet("Spider","assets/spritesheets/Spider/Spider.json"),this.load.spritesheet("SpiderBoss","assets/spritesheets/SpiderBoss/SpiderBoss.json"),this.load.audio("bluddington","assets/music/bluddington.mp3")}startScene(){super.startScene(),this.player.node.position=new r(150,250),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,2048,1280),this.triggeredBoss=!1,this.nextLevel=ft,this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0})}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}update(e){super.update(e),!this.triggeredBoss&&this.player.node.position.x>672&&(this.triggeredBoss=!0,this.spawnBoss(),this.firstWave())}spawnBoss(){const e=this.resourceManager.getTilemap("tilemap").layers.find(i=>i.name=="BossSpawn").objects,t=new us(this.add.animatedSprite("SpiderBoss",x.Main),new r(e[0].x,e[0].y));this.boss=t,this.enemies.push(t)}firstWave(){const e=this.resourceManager.getTilemap("tilemap").layers.find(i=>i.name=="SpiderSpawn").objects,t=this.resourceManager.getTilemap("tilemap").layers.find(i=>i.name=="GhostSpawn").objects;for(let i=0;i<e.length;i++){const s=new Yt(this.add.animatedSprite("Spider",x.Main),new r(e[i].x,e[i].y));this.enemies.push(s)}for(let i=0;i<t.length;i++){const s=new Ze(this.add.animatedSprite("RedSoul",x.Main),new r(t[i].x,t[i].y),Ae.RED);this.enemies.push(s)}}}class ws{destroy(){delete this.owner}}class Ss extends ws{activate(e){}handleEvent(e){}initializeAI(e,t){this.owner=e,this.message=this.owner.getScene().add.uiElement(N.LABEL,x.UI,{position:this.owner.relativePosition.clone().mult(new r(-.1,.1)),text:t.message}),this.message.textColor=g.WHITE,this.message.font="Mister Pixel"}changeActive(e){this.active!=e&&(this.active=e,this.active?(this.owner.animation.playIfNotAlready("Display",!0),this.message.visible=!0):(this.owner.animation.playIfNotAlready("Idle",!1),this.message.visible=!1))}update(e){this.changeActive(this.owner.collisionShape.overlaps(this.owner.getScene().player.node.collisionShape)),this.message.position=this.owner.relativePosition.clone().mult(new r(.5,.5)).add(new r(0,-50))}}class jt extends Oe{constructor(e,t,i){super(),this.node=e,this.health=1/0,this.node.position=t,this.node.animation.play("Idle"),this.node.addPhysics(void 0,void 0,!1),this.node.addAI(Ss,{message:i})}}class yt extends Pe{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/Level2/Level2.json"),this.load.spritesheet("Monolith","assets/spritesheets/Monolith/Monolith.json"),this.load.spritesheet("Ghost","assets/spritesheets/RedSoul/RedSoul.json"),this.load.spritesheet("Spider","assets/spritesheets/Spider/Spider.json"),this.load.audio("bluddington","assets/music/bluddington.mp3")}startScene(){super.startScene(),this.player.node.position=new r(100,1e3),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,6400,1280),this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0}),this.nextLevel=mt,this.addLevelEnd(new r(3170,691),new r(32,135)),this.initializeMonoliths(),this.initializeGhosts(),this.initializeSpiders()}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}initializeMonoliths(){this.resourceManager.getTilemap("tilemap").layers.find(e=>e.name=="Monoliths").objects.forEach(e=>{new jt(this.add.animatedSprite("Monolith",x.Main),new r(e.x,e.y),e.name)})}initializeGhosts(){this.resourceManager.getTilemap("tilemap").layers.find(e=>e.name=="Ghosts").objects.forEach(e=>{this.enemies.push(new Ze(this.add.animatedSprite("Ghost",x.Main),new r(e.x,e.y),"red"))})}initializeSpiders(){this.resourceManager.getTilemap("tilemap").layers.find(e=>e.name=="Spiders").objects.forEach(e=>{this.enemies.push(new Yt(this.add.animatedSprite("Spider",x.Main),new r(e.x,e.y)))})}}class at extends Pe{loadScene(){super.loadScene(),this.load.tilemap("tilemap","assets/tilemaps/Level1/Level1.json"),this.load.spritesheet("RedSoul","assets/spritesheets/RedSoul/RedSoul.json"),this.load.spritesheet("Monolith","assets/spritesheets/Monolith/Monolith.json"),this.load.image("bg","assets/tilemaps/Level1/limbo_bg.jpg"),this.load.audio("bluddington","assets/music/fire1.wav")}unloadScene(){this.emitter.fireEvent(p.STOP_SOUND,{key:"bluddington"}),super.unloadScene()}startScene(){super.startScene(),this.player.node.position=new r(100,1e3),this.camera.node.position=this.player.node.position.clone(),this.add.tilemap("tilemap",new r(1,1)),this.viewport.setBounds(0,0,6400,1280);const e=this.add.sprite("bg",x.Parallax);e.alpha=.3,e.position=new r(300,200),e.scale=new r(8,8),this.nextLevel=yt,this.addLevelEnd(new r(4576,128),new r(32,135)),this.emitter.fireEvent(p.PLAY_MUSIC,{key:"bluddington",loop:!0,holdReference:!0}),this.initializeGhosts(),this.initializeMonoliths()}initializeMonoliths(){this.resourceManager.getTilemap("tilemap").layers.find(e=>e.name=="Monoliths").objects.forEach(e=>{new jt(this.add.animatedSprite("Monolith",x.Main),new r(e.x,e.y),e.name)})}initializeGhosts(){const e=this.resourceManager.getTilemap("tilemap").layers.find(t=>t.name=="Ghosts").objects;for(let t=0;t<e.length;t++){const i=new Ze(this.add.animatedSprite("RedSoul",x.Main),new r(e[t].x,e[t].y),Ae.RED);this.enemies.push(i)}}}var E;(function(n){n.Left="left",n.Right="right",n.Jump="jump",n.Attack="attack",n.Dash="dash",n.Pause="pause",n.Up="up",n.Down="down",n.Invincible="invincible",n.Level1="level1",n.Level2="level2",n.Level3="level3",n.Level4="level4",n.Level5="level5",n.Level6="level6"})(E||(E={}));const C={MAIN_MENU:"MAIN_MENU",PLAYER_DAMAGE:"PLAYER_DAMAGE",PLAYER_HEAL:"PLAYER_HEAL",PLAYER_DEATH:"PLAYER_DEATH",ENEMY_DEATH:"ENEMY_DEATH",ENEMY_DAMAGE:"ENEMY_DAMAGE",LEVEL_END:"LEVEL_END",ENTER_LEVEL_END:"ENTER_LEVEL_END"},ee={PLAYER_PHYS:"PLAYER_PHYS",ENEMY_PHYS:"ENEMY_PHYS",HITBOX_PHYS:"HITBOX_PHYS"},wt={SOUL:new r(9,12),PLAYER:new r(18,24),ZOMBIE:new r(12,16)},xe={Level1:at,Level2:yt,Level3:mt,Level4:ft,Level5:gt,Level6:ct},Ue={GHOST_RED:"ghost_red"},G={physics:{groupNames:[ee.PLAYER_PHYS,ee.ENEMY_PHYS,ee.HITBOX_PHYS],collisions:[[0,0,1],[0,0,1],[0,1,0]]}};var v;(function(n){n.Main="main",n.Levels="level",n.Controls="control",n.Help="help",n.Back="back"})(v||(v={}));class rt extends Ot{constructor(){super(...arguments),this.textColor=new g(231,224,241)}loadScene(){this.load.image("logo","/assets/images/autopsy_logo.png"),this.load.image("levelSelect","/assets/images/level_selection.png"),this.screens={[v.Main]:this.addUILayer(v.Main),[v.Levels]:this.addUILayer(v.Levels),[v.Controls]:this.addUILayer(v.Controls),[v.Help]:this.addUILayer(v.Help),[v.Back]:this.addUILayer(v.Back)}}startScene(){const e=this.viewport.getHalfSize();this.viewport.setFocus(e),this.viewport.setZoomLevel(1),this.currentScreen=v.Main;for(const t in this.screens)this.screens[t].setHidden(!0);this.initMainMenu(),this.initLevelsLayer(),this.initHelpLayer(),this.initControlsMenu(),this.initBackLayer(),this.screens[v.Main].setHidden(!1)}changeLayer(e){this.screens[this.currentScreen].disable(),this.screens[e].enable(),this.currentScreen=e,this.screens[v.Back].setHidden(this.currentScreen==v.Main)}initBackLayer(){const t=this.newButton(new r(60,this.viewport.getHalfSize().y*2-100),"BACK",40,v.Back);t.size.x=120,t.size.y=70,t.onClick=()=>{this.changeLayer(v.Main)}}initHelpLayer(){["You play as an undertaker and have to hunt souls that"," have escaped from hell using an arsenal of weapons. "].forEach((i,s)=>{const a=this.add.uiElement(N.LABEL,v.Help,{position:new r(600,200+40*s),text:i});a.textColor=this.textColor,a.font="Mister Pixel"});const e=500,t=this.add.uiElement(N.LABEL,v.Help,{position:new r(this.viewport.getHalfSize().x*2-e/2-10,this.viewport.getHalfSize().y*2-20),text:"By Alvin Mei, Yu-Xiang Zheng, Andrew Ton"});t.size.x=e,t.setHAlign($.RIGHT),t.textColor=this.textColor,t.font="Mister Pixel",["Cheats","","Invincibility: I","Change Level: 1-6"].forEach((i,s)=>{const a=this.add.uiElement(N.LABEL,v.Help,{position:new r(600,500+40*s),text:i});a.textColor=this.textColor,a.font="Mister Pixel"})}initLevelsLayer(){const e=this.add.sprite("levelSelect",v.Levels);e.position=new r(600,400),e.scale=new r(.8,.8);const t=40,i=new r(70,70),s=new r(15,15),a=this.newButton(new r(255,645),"1",t,v.Levels,!0),o=this.newButton(new r(360,320),"2",t,v.Levels,!0),d=this.newButton(new r(565,495),"3",t,v.Levels,!0),h=this.newButton(new r(773,550),"4",t,v.Levels,!0),c=this.newButton(new r(914,342),"5",t,v.Levels,!0),u=this.newButton(new r(798,118),"6",t,v.Levels,!0);a.font="Mister Pixel",a.setPadding(s),a.size=i,a.borderColor=g.TRANSPARENT,a.onClick=()=>{this.sceneManager.changeToScene(at,{},G)},o.font="Mister Pixel",o.setPadding(s),o.size=i,o.borderColor=g.TRANSPARENT,o.onClick=()=>{this.sceneManager.changeToScene(yt,{},G)},d.font="Mister Pixel",d.setPadding(s),d.size=i,d.borderColor=g.TRANSPARENT,d.onClick=()=>{this.sceneManager.changeToScene(mt,{},G)},h.font="Mister Pixel",h.setPadding(s),h.size=i,h.borderColor=g.TRANSPARENT,h.onClick=()=>{this.sceneManager.changeToScene(ft,{},G)},c.font="Mister Pixel",c.setPadding(s),c.size=i,c.borderColor=g.TRANSPARENT,c.onClick=()=>{this.sceneManager.changeToScene(gt,{},G)},u.font="Mister Pixel",u.setPadding(s),u.size=i,u.borderColor=g.TRANSPARENT,u.onClick=()=>{this.sceneManager.changeToScene(ct,{},G)}}initControlsMenu(){["(A), (D): Move left and right respectively.","(Space): Jump.","(J): Attack.","(Shift): Dash.","(ESC): Pause game."].forEach((e,t)=>{const i=this.add.uiElement(N.LABEL,v.Controls,{position:new r(600,200+40*t),text:e});i.textColor=this.textColor,i.font="Mister Pixel",i.size.x=1e3,i.setHAlign($.LEFT)})}initMainMenu(){this.add.sprite("logo",v.Main).position=new r(this.viewport.getHalfSize().x,200);const e=500,t=this.newButton(new r(e/2,400),"PLAY",60,v.Main);t.setHAlign($.LEFT),t.size.x=e,t.size.y=80,t.onClick=()=>{this.sceneManager.changeToScene(at,{},G)};const i=this.newButton(new r(e/2,490),"LEVELS",60,v.Main);i.setHAlign($.LEFT),i.size.x=e,i.size.y=80,i.onClick=()=>this.changeLayer(v.Levels);const s=this.newButton(new r(e/2,400+90*2),"CONTROLS",60,v.Main);s.setHAlign($.LEFT),s.size.x=e,s.size.y=80,s.onClick=()=>this.changeLayer(v.Controls);const a=130,o=this.newButton(new r(this.viewport.getHalfSize().x*2-a/2,700),"HELP",50,v.Main);o.setHAlign($.CENTER),o.size.x=a,o.size.y=80,o.onClick=()=>this.changeLayer(v.Help)}newButton(e,t,i,s,a=!1){const o=this.add.uiElement(N.BUTTON,s,{position:e,text:t});o.backgroundColor=g.TRANSPARENT,o.borderColor=g.WHITE,o.borderWidth=1,o.borderRadius=0,o.setPadding(new r(50,10)),o.font="MEGAPIX",o.fontSize=i,o.textColor=this.textColor;const d=new g(255,255,255,.1),h=new g(255,255,255,0);return a?(o.onEnter=()=>{o.textColor=new g(246,242,252)},o.onLeave=()=>{o.textColor=this.textColor}):(o.onEnter=()=>{o.backgroundColor=d},o.onLeave=()=>{o.backgroundColor=h}),o}}(function(){const e={canvasSize:{x:1200,y:800},clearColor:{r:34,g:28,b:41},inputs:[{name:E.Left,keys:["a"]},{name:E.Right,keys:["d"]},{name:E.Up,keys:["w"]},{name:E.Down,keys:["s"]},{name:E.Jump,keys:["space"]},{name:E.Attack,keys:["j"]},{name:E.Dash,keys:["shift"]},{name:E.Pause,keys:["escape"]},{name:E.Invincible,keys:["i"]},{name:E.Level1,keys:["1"]},{name:E.Level2,keys:["2"]},{name:E.Level3,keys:["3"]},{name:E.Level4,keys:["4"]},{name:E.Level5,keys:["5"]},{name:E.Level6,keys:["6"]}],useWebGL:!1,showDebug:!1};new xi(e).start(rt,{})})();
